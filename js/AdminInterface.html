<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <link href="https://unpkg.com/tailwindcss@^2/dist/tailwind.min.css" rel="stylesheet">
    <style>
      .loader {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      .tab-button {
        transition: all 0.2s ease-in-out;
      }
      .tab-button.active {
        border-color: #3b82f6;
        color: #3b82f6;
        background-color: #eff6ff;
      }
      /* Style pour le modal */
      #edit-modal-bg { transition: opacity 0.3s ease; }
      #edit-modal-panel { transition: all 0.3s ease; }
    </style>
  </head>
  <body class="p-4 bg-gray-50">

    <div id="loading-state">
      <div class="loader mx-auto"></div>
      <p class="text-center text-gray-600 mt-2">Chargement des catégories...</p>
    </div>

    <div id="main-content" class="hidden opacity-0 transition-opacity duration-500">
      <!-- Onglets de navigation -->
      <div class="border-b border-gray-200 mb-4">
        <nav class="-mb-px flex space-x-4" aria-label="Tabs">
          <button onclick="switchTab('tab-bilan')" class="tab-button active whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm">Bilan & Ajout</button>
          <button onclick="switchTab('tab-gestion')" class="tab-button whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">Gérer les Produits</button>
          <button onclick="switchTab('tab-outils')" class="tab-button whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">Outils Avancés</button>
        </nav>
      </div>

      <!-- Contenu des onglets -->
      <div id="tabs-content">
        <!-- Onglet 1: Bilan & Ajout -->
        <div id="tab-bilan">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Section Ajout de produit -->
            <div>
              <h3 class="text-lg font-bold text-gray-800 mb-3">Ajouter un Produit</h3>
              <form id="addProductForm" class="space-y-3 bg-white p-4 rounded-lg shadow">
                <div>
                  <label for="category-select" class="block text-sm font-medium text-gray-700">Choisir une catégorie</label>
                  <select id="category-select" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required></select>
                </div>
                <input type="text" id="nom" placeholder="Nom du produit" class="w-full p-2 border rounded" required />
                <input type="text" id="marque" placeholder="Marque" class="w-full p-2 border rounded" />
                <input type="number" id="prixActuel" placeholder="Prix Actuel" class="w-full p-2 border rounded" required />
                <input type="number" id="reduction" placeholder="Réduction en %" class="w-full p-2 border rounded" value="0" />
                <input type="number" id="stock" placeholder="Stock" class="w-full p-2 border rounded" required />
                <input type="text" id="imageURL" placeholder="URL de l'image principale" class="w-full p-2 border rounded" />
                <textarea id="galerie" placeholder="URLs de la galerie (séparées par des virgules)" class="w-full p-2 border rounded h-20"></textarea>
                <textarea id="description" placeholder="Description" class="w-full p-2 border rounded h-24"></textarea>
                <input type="text" id="tags" placeholder="Tags (séparés par des virgules)" class="w-full p-2 border rounded" />

                <button type="submit" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded hover:bg-blue-700">
                  Ajouter le Produit
                </button>
              </form>
              <div id="status" class="mt-4 text-center"></div>
            </div>
            <!-- Section Bilan -->
            <div id="category-summary-container">
              <!-- Le bilan sera injecté ici -->
            </div>
          </div>
        </div>

        <!-- Onglet 2: Gérer les Produits -->
        <div id="tab-gestion" class="hidden">
          <h3 class="text-lg font-bold text-gray-800 mb-3">Gérer les Produits</h3>
          <div class="mb-4">
            <button id="load-products-btn" onclick="loadAllProducts()" class="bg-gray-700 text-white px-4 py-2 rounded">Charger tous les produits</button>
          </div>
          <div id="product-list-container" class="bg-white p-4 rounded-lg shadow">
            <p class="text-gray-500">Cliquez sur "Charger" pour afficher la liste des produits.</p>
          </div>
        </div>

        <!-- Onglet 3: Outils Avancés -->
        <div id="tab-outils" class="hidden">
          <h3 class="text-lg font-bold text-gray-800 mb-3">Outils Avancés</h3>
          <div class="space-y-4">
            <div class="bg-white p-4 rounded-lg shadow">
              <h4 class="font-semibold">Archiver les produits épuisés</h4>
              <p class="text-sm text-gray-600 mb-2">Déplace les produits avec un stock de 0 vers un onglet "Produits Archivés" dans chaque feuille de catégorie.</p>
              <button onclick="runArchive()" class="bg-yellow-500 text-white px-4 py-2 rounded text-sm">Lancer l'archivage</button>
            </div>
            <div class="bg-white p-4 rounded-lg shadow">
              <h4 class="font-semibold">Supprimer les doublons</h4>
              <p class="text-sm text-gray-600 mb-2">Recherche et supprime les produits ayant exactement le même nom (non implémenté).</p>
              <button class="bg-red-600 text-white px-4 py-2 rounded text-sm opacity-50 cursor-not-allowed">Lancer la suppression</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal pour l'édition de produit -->
    <div id="edit-modal" class="fixed inset-0 z-50 hidden items-center justify-center">
      <div id="edit-modal-bg" class="absolute inset-0 bg-gray-900 bg-opacity-50" onclick="closeEditModal()"></div>
      <div id="edit-modal-panel" class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg z-10 transform scale-95 opacity-0">
        <h3 class="text-xl font-bold mb-4">Modifier le Produit</h3>
        <form id="editProductForm" class="space-y-3">
          <input type="hidden" id="edit-IDProduit">
          <input type="hidden" id="edit-Catégorie">
          <div><label class="text-sm">Nom</label><input type="text" id="edit-Nom" class="w-full p-2 border rounded"></div>
          <div><label class="text-sm">Marque</label><input type="text" id="edit-Marque" class="w-full p-2 border rounded"></div>
          <div><label class="text-sm">Prix</label><input type="number" id="edit-PrixActuel" class="w-full p-2 border rounded"></div>
          <div><label class="text-sm">Stock</label><input type="number" id="edit-Stock" class="w-full p-2 border rounded"></div>
          <div class="flex justify-end space-x-3 pt-4">
            <button type="button" onclick="closeEditModal()" class="px-4 py-2 bg-gray-200 rounded">Annuler</button>
            <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded">Enregistrer</button>
          </div>
        </form>
      </div>
    </div>

    <script>
      // URL du script central de gestion des catégories
      let categoriesData = [];
      let allProductsData = [];

      // Au chargement de la sidebar, on récupère les catégories
      window.addEventListener('load', fetchCategories);

      async function fetchCategories() {
        try {
          // Utiliser google.script.run pour éviter les problèmes de CORS avec fetch dans la sidebar
          google.script.run
            .withSuccessHandler(onCategoriesLoaded)
            .withFailureHandler(onFailure)
            .getCategoriesWithProductCounts();

        } catch (e) { onFailure(e); }
      }

      function onCategoriesLoaded(categories) {
        categoriesData = categories;
        const selectEl = document.getElementById('category-select');
        selectEl.innerHTML = '<option value="">-- Sélectionnez --</option>';
        categoriesData.forEach(cat => {
          const count = typeof cat.ProductCount === 'number' ? cat.ProductCount : '?';
          const option = document.createElement('option');
          option.value = cat.IDCategorie;
          option.textContent = `${cat.NomCategorie} (${count} produits)`;
          selectEl.appendChild(option);
        });

        displayCategorySummary();

        document.getElementById('loading-state').classList.add('hidden');
        const mainContent = document.getElementById('main-content');
        mainContent.classList.remove('hidden');
        setTimeout(() => mainContent.classList.remove('opacity-0'), 50); // Fade in
      }

      function displayCategorySummary() {
        const summaryContainer = document.getElementById('category-summary-container');
        summaryContainer.innerHTML = ''; // Clear previous content

        const summaryDiv = document.createElement('div');
        summaryDiv.className = 'bg-white p-4 rounded-lg shadow';
        summaryDiv.innerHTML = '<h3 class="text-lg font-bold mb-3">Bilan des Catégories</h3>';
        
        if (categoriesData.length === 0) {
          summaryDiv.innerHTML += '<p class="text-gray-500">Aucune catégorie configurée.</p>';
        } else {
          let totalProducts = 0;
          let summaryList = '<ul class="list-disc pl-5 text-sm text-gray-700 space-y-1">';
          categoriesData.forEach(cat => {
            const count = typeof cat.ProductCount === 'number' ? cat.ProductCount : 0;
            const countText = typeof cat.ProductCount === 'number' ? `${count} produits` : `<span class="text-red-500">${cat.ProductCount}</span>`;
            const numeroText = cat.Numero ? `<span class="text-xs text-gray-500 ml-2 font-mono">${cat.Numero}</span>` : '';
            totalProducts += count;
            summaryList += `<li class="flex justify-between items-center"><span>${cat.NomCategorie}: <span class="font-semibold">${countText}</span></span>${numeroText}</li>`;
          });
          summaryList += '</ul>';
          summaryDiv.innerHTML += summaryList;
          summaryDiv.innerHTML += `<p class="mt-4 text-md font-bold">Total général: <span class="text-blue-600">${totalProducts} produits</span></p>`;
        }
        summaryContainer.appendChild(summaryDiv);
      }

      function loadAllProducts() {
        const container = document.getElementById('product-list-container');
        container.innerHTML = '<div class="loader mx-auto"></div>';
        document.getElementById('load-products-btn').disabled = true;
        google.script.run
          .withSuccessHandler(displayAllProducts)
          .withFailureHandler(onFailure)
          .getAllProducts();
      }

      function displayAllProducts(products) {
        document.getElementById('load-products-btn').disabled = false;
        allProductsData = products;
        const container = document.getElementById('product-list-container');
        if (!products || products.length === 0) {
          container.innerHTML = '<p class="text-gray-500">Aucun produit trouvé.</p>';
          return;
        }

        let tableHTML = `
          <input type="text" id="product-search-input" onkeyup="filterProducts()" placeholder="Rechercher un produit..." class="w-full p-2 border rounded mb-4">
          <div class="overflow-x-auto max-h-96">
            <table id="products-table" class="min-w-full divide-y divide-gray-200 text-sm">
              <thead class="bg-gray-50 sticky top-0">
                <tr>
                  <th class="px-4 py-2 text-left font-medium text-gray-500">Nom</th>
                  <th class="px-4 py-2 text-left font-medium text-gray-500">Catégorie</th>
                  <th class="px-4 py-2 text-left font-medium text-gray-500">Prix</th>
                  <th class="px-4 py-2 text-left font-medium text-gray-500">Stock</th>
                  <th class="px-4 py-2 text-left font-medium text-gray-500">Actions</th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-200">
                ${products.map(p => `
                  <tr data-product-id="${p.IDProduit}">
                    <td class="px-4 py-2 font-medium">${p.Nom}</td>
                    <td class="px-4 py-2">${p.Catégorie}</td>
                    <td class="px-4 py-2">${p.PrixActuel}</td>
                    <td class="px-4 py-2">${p.Stock}</td>
                    <td class="px-4 py-2 space-x-2">
                      <button onclick="openEditModal('${p.IDProduit}')" class="text-blue-600 hover:underline">Modifier</button>
                      <button onclick="deleteProduct('${p.IDProduit}')" class="text-red-600 hover:underline">Supprimer</button>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        `;
        container.innerHTML = tableHTML;
      }

      function filterProducts() {
        const input = document.getElementById('product-search-input');
        const filter = input.value.toLowerCase();
        const table = document.getElementById('products-table');
        const tr = table.getElementsByTagName('tr');

        for (let i = 1; i < tr.length; i++) { // Start from 1 to skip header
          const tdName = tr[i].getElementsByTagName('td')[0];
          const tdCat = tr[i].getElementsByTagName('td')[1];
          if (tdName || tdCat) {
            const txtValue = (tdName.textContent || tdName.innerText) + (tdCat.textContent || tdCat.innerText);
            if (txtValue.toLowerCase().indexOf(filter) > -1) {
              tr[i].style.display = "";
            } else {
              tr[i].style.display = "none";
            }
          }
        }
      }

      // Gère la soumission du formulaire
      document.getElementById('addProductForm').addEventListener('submit', async function(e) {
          e.preventDefault();
          const statusDiv = document.getElementById('status');
          statusDiv.innerHTML = '<div class="loader mx-auto"></div>';

          const selectedCategoryId = document.getElementById('category-select').value;
          const selectedCategory = categoriesData.find(cat => cat.IDCategorie === selectedCategoryId);

          if (!selectedCategory || !selectedCategory.ScriptURL) {
              onFailure({ message: "Veuillez sélectionner une catégorie valide avec une URL de script configurée." });
              return;
          }

          const productData = {
            nom: document.getElementById('nom').value,
            marque: document.getElementById('marque').value,
            categorie: selectedCategory.NomCategorie,
            prixActuel: parseFloat(document.getElementById('prixActuel').value || 0),
            reduction: parseFloat(document.getElementById('reduction').value || 0),
            stock: parseInt(document.getElementById('stock').value || 0),
            imageURL: document.getElementById('imageURL').value,
            galerie: document.getElementById('galerie').value,
            description: document.getElementById('description').value,
            tags: document.getElementById('tags').value
          };

          // On utilise fetch ici car google.script.run ne gère pas bien les appels dynamiques à des URL externes
          fetch(selectedCategory.ScriptURL, {
              method: 'POST',
              body: JSON.stringify({ action: 'ajouterProduit', data: productData }),
              headers: { 'Content-Type': 'application/json' },
              mode: 'no-cors' // Important pour les appels de script à script
          })
          .then(res => {
              // Avec no-cors, on ne peut pas lire la réponse, mais on sait que la requête est partie.
              // On simule un succès pour l'UI.
              onProductAdded({ id: 'Nouveau' });
          })
          .catch(onFailure);
      });

      function openEditModal(productId) {
        const product = allProductsData.find(p => p.IDProduit === productId);
        if (!product) return;

        document.getElementById('edit-IDProduit').value = product.IDProduit;
        document.getElementById('edit-Catégorie').value = product.Catégorie;
        document.getElementById('edit-Nom').value = product.Nom;
        document.getElementById('edit-Marque').value = product.Marque;
        document.getElementById('edit-PrixActuel').value = product.PrixActuel;
        document.getElementById('edit-Stock').value = product.Stock;

        const modal = document.getElementById('edit-modal');
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        setTimeout(() => {
          document.getElementById('edit-modal-bg').classList.remove('opacity-0');
          document.getElementById('edit-modal-panel').classList.remove('opacity-0', 'scale-95');
        }, 10);
      }

      function closeEditModal() {
        const modal = document.getElementById('edit-modal');
        document.getElementById('edit-modal-bg').classList.add('opacity-0');
        document.getElementById('edit-modal-panel').classList.add('opacity-0', 'scale-95');
        setTimeout(() => {
          modal.classList.add('hidden');
          modal.classList.remove('flex');
        }, 300);
      }

      document.getElementById('editProductForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const statusDiv = document.getElementById('status');
        statusDiv.innerHTML = '<div class="loader mx-auto"></div>';

        const updatedData = {
          IDProduit: document.getElementById('edit-IDProduit').value,
          Catégorie: document.getElementById('edit-Catégorie').value,
          Nom: document.getElementById('edit-Nom').value,
          Marque: document.getElementById('edit-Marque').value,
          PrixActuel: parseFloat(document.getElementById('edit-PrixActuel').value),
          Stock: parseInt(document.getElementById('edit-Stock').value),
        };

        google.script.run
          .withSuccessHandler(onProductUpdated)
          .withFailureHandler(onFailure)
          .updateProduct(updatedData);
      });

      function onProductUpdated(response) {
        if (response.success) {
          document.getElementById('status').innerHTML = `<p class="text-green-600">Produit ${response.id} mis à jour avec succès.</p>`;
          closeEditModal();
          loadAllProducts(); // Recharger la liste pour voir les changements
        } else {
          onFailure(response);
        }
      }

      function deleteProduct(productId) {
        const product = allProductsData.find(p => p.IDProduit === productId);
        if (!product) return;

        if (confirm(`Êtes-vous sûr de vouloir supprimer le produit "${product.Nom}" ?`)) {
          const statusDiv = document.getElementById('status');
          statusDiv.innerHTML = '<div class="loader mx-auto"></div>';
          google.script.run
            .withSuccessHandler(response => {
              if (response.success) {
                statusDiv.innerHTML = `<p class="text-green-600">Produit ${response.id} supprimé.</p>`;
                loadAllProducts(); // Recharger la liste
              } else { onFailure(response); }
            })
            .withFailureHandler(onFailure)
            .deleteProduct({ IDProduit: product.IDProduit, Catégorie: product.Catégorie });
        }
      }

      function runArchive() {
        const statusDiv = document.getElementById('status');
        statusDiv.innerHTML = '<div class="loader mx-auto"></div><p>Archivage en cours...</p>';
        google.script.run
          .withSuccessHandler(res => {
            statusDiv.innerHTML = `<p class="text-green-600">${res.message}</p>`;
          })
          .withFailureHandler(onFailure)
          .archiveAllOutOfStock();
      }

      function onProductAdded(response) {
        const statusDiv = document.getElementById('status');
        statusDiv.innerHTML = `<p class="text-green-600">Produit ajouté avec succès (ID: ${response.id}).</p>`;
        document.getElementById('addProductForm').reset();
      }

      function onFailure(error) {
        const statusDiv = document.getElementById('status');
        statusDiv.innerHTML = `<p class="text-red-600">Erreur: ${error.error || error.message}</p>`;
      }

      function switchTab(tabId) {
        // Hide all tab contents
        document.querySelectorAll('#tabs-content > div').forEach(child => {
          child.classList.add('hidden');
        });
        // Deactivate all tab buttons
        document.querySelectorAll('.tab-button').forEach(button => {
          button.classList.remove('active');
        });
        // Show the selected tab content and activate its button
        document.getElementById(tabId).classList.remove('hidden');
        const button = document.querySelector(`button[onclick="switchTab('${tabId}')"]`);
        if (button) button.classList.add('active');
      }
    </script>
  </body>
</html>