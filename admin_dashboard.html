<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tableau de Bord Admin - ABMCY MARKET</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- NOUVEAU: Ajout de la bibliothèque Chart.js pour les graphiques -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap">
    <style>
        :root { --gold-color: #D4AF37; }
        .font-montserrat { font-family: 'Montserrat', sans-serif; }
        .text-gold { color: var(--gold-color); }
        .bg-gold { background-color: var(--gold-color); }
        .border-gold { border-color: var(--gold-color); }
        
        /* Style pour les interrupteurs (toggle switch) */
        .switch { position: relative; display: inline-block; width: 60px; height: 34px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--gold-color); }
        input:checked + .slider:before { transform: translateX(26px); }

        /* Style pour les onglets */
        .tab-button.active {
            border-color: var(--gold-color);
            color: var(--gold-color);
        }
    </style>
</head>
<body class="bg-gray-100 font-montserrat">

    <!-- En-tête (similaire à vos autres pages pour la cohérence) -->
    <div class="sticky top-0 z-40 bg-white shadow-md">
        <header>
            <div class="container mx-auto px-4 py-2 flex items-center justify-between">
                <a href="index.html" class="flex items-center">
                    <img src="logo/l.svg" alt="ABMCY MARKET Logo" class="h-10">
                    <span class="ml-3 text-xl font-bold text-gray-800">PANNEAU ADMIN</span>
                </a>
                <div class="flex items-center space-x-4">
                    <a href="compte.html" class="text-gray-600 font-semibold flex items-center gap-2">
                        <span>Mon Compte</span>
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                    </a>
                </div>
            </div>
        </header>
    </div>

    <main class="container mx-auto px-4 py-8 space-y-12">
        <div>
            <h1 class="text-3xl font-bold text-gray-800">Tableau de Bord Administrateur</h1>
            <p class="text-gray-600 mt-1">Gérez les paramètres globaux de la plateforme.</p>
        </div>

        <!-- NOUVEAU: Navigation par onglets -->
        <div class="border-b border-gray-200">
            <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                <button id="tab-btn-payments" class="tab-button active whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                    Gestion des Paiements
                </button>
                <button id="tab-btn-accounts" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                    Gestion des Comptes
                </button>
            </nav>
        </div>

        <!-- Contenu de l'onglet Paiements -->
        <div id="tab-content-payments" class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2">
                <section class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-bold text-gray-800 mb-6">Gestion des Agrégateurs de Paiement</h2>
                    <p class="text-sm text-gray-600 mb-6">Choisissez l'agrégateur de paiement par défaut pour les transactions "Mobile Money". Un seul peut être actif à la fois.</p>
                    
                    <div class="space-y-4">
                        <!-- Option 1: Paydunya -->
                        <label for="default-aggregator-paydunya" class="block border rounded-lg p-4 cursor-pointer has-[:checked]:bg-blue-50 has-[:checked]:border-blue-400">
                            <div class="flex items-center">
                                <input type="radio" id="default-aggregator-paydunya" name="default-aggregator" value="paydunya" class="h-4 w-4 text-gold focus:ring-gold border-gray-300">
                                <div class="flex items-center gap-4">
                                    <img src="https://paydunya.com/assets/img/logo-paydunya-bleu.png" alt="Logo Paydunya" class="h-10 object-contain">
                                    <span class="font-bold text-lg">Paydunya</span>
                                </div>
                            </div>
                            <div class="mt-4 pl-8 space-y-2 text-sm">
                                <div>
                                    <label for="paydunya-master-key" class="font-medium text-gray-600">Clé Maître (Master Key)</label>
                                    <input type="text" id="paydunya-master-key" placeholder="Entrez la clé maître" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-gold focus:border-gold">
                                </div>
                                <div>
                                    <label for="paydunya-private-key" class="font-medium text-gray-600">Clé Privée</label>
                                    <input type="text" id="paydunya-private-key" placeholder="Entrez la clé privée" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-gold focus:border-gold">
                                </div>
                                <div>
                                    <label for="paydunya-token" class="font-medium text-gray-600">Jeton (Token)</label>
                                    <input type="text" id="paydunya-token" placeholder="Entrez le jeton" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-gold focus:border-gold">
                                </div>
                            </div>
                        </label>

                        <!-- Option 2: PawaPay -->
                        <label for="default-aggregator-pawapay" class="block border rounded-lg p-4 cursor-pointer has-[:checked]:bg-blue-50 has-[:checked]:border-blue-400">
                            <div class="flex items-center">
                                <input type="radio" id="default-aggregator-pawapay" name="default-aggregator" value="pawapay" class="h-4 w-4 text-gold focus:ring-gold border-gray-300">
                                <div class="flex items-center gap-4">
                                    <img src="https://pawapay.io/wp-content/uploads/2023/08/logo-blue.svg" alt="Logo Pawa Pays" class="h-8 object-contain">
                                    <span class="font-bold text-lg">PawaPay</span>
                                </div>
                            </div>
                            <div class="mt-4 pl-8 space-y-2 text-sm">
                                <div>
                                    <label for="pawapay-api-key" class="font-medium text-gray-600">Clé API (Bearer Token)</label>
                                    <input type="text" id="pawapay-api-key" placeholder="Entrez la clé API de PawaPay" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-gold focus:border-gold">
                                </div>
                                <div>
                                    <label for="pawapay-webhook-secret" class="font-medium text-gray-600">Secret du Webhook</label>
                                    <input type="text" id="pawapay-webhook-secret" placeholder="Entrez le secret du webhook de PawaPay" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-gold focus:border-gold">
                                </div>
                            </div>
                        </label>
                    </div>

                    <div class="flex justify-end mt-6">
                        <button id="save-aggregators" class="px-6 py-2 bg-black text-white font-bold rounded-lg hover:bg-gray-800">
                            Enregistrer les modifications
                        </button>
                    </div>
                </section>

                <!-- NOUVEAU: Section Transactions Récentes -->
                <section class="bg-white p-6 rounded-lg shadow-md mt-8">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-gray-800">Transactions Récentes</h2>
                        <button id="refresh-transactions-btn" class="text-sm text-blue-600 hover:underline font-semibold">Rafraîchir</button>
                    </div>
                    <div id="transactions-container" class="space-y-3 max-h-96 overflow-y-auto">
                        <!-- Le contenu sera injecté ici -->
                        <p class="text-center text-gray-500 py-4">Chargement des transactions...</p>
                    </div>
                </section>

                <!-- NOUVEAU: Section Export de Données -->
                <section class="bg-white p-6 rounded-lg shadow-md mt-8">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Export de Données</h2>
                    <p class="text-sm text-gray-600 mb-4">Téléchargez les données brutes de vos commandes pour une analyse externe ou pour vos archives.</p>
                    <div class="flex justify-start">
                        <button id="export-orders-btn" class="flex items-center gap-2 px-5 py-2 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 transition">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                            Exporter les Commandes (CSV)
                        </button>
                    </div>
                </section>
            </div>

            <div class="space-y-8">
                <!-- NOUVEAU: Section Graphique des Ventes -->
                <section class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Ventes des 7 derniers jours</h2>
                    <div id="sales-chart-container" class="relative h-64">
                        <canvas id="salesChart"></canvas>
                        <div id="chart-loader" class="absolute inset-0 flex items-center justify-center bg-white bg-opacity-75"><p>Chargement du graphique...</p></div>
                    </div>
                </section>

                <section class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Envoyer une Notification</h2>
                    <form id="notification-form" class="space-y-4">
                        <div>
                            <label for="notification-title" class="block text-sm font-medium text-gray-700">Titre</label>
                            <input type="text" id="notification-title" placeholder="Ex: Nouvelle promotion !" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-gold focus:border-gold" required>
                        </div>
                        <div>
                            <label for="notification-message" class="block text-sm font-medium text-gray-700">Message</label>
                            <textarea id="notification-message" rows="4" placeholder="Détails de la notification..." class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-gold focus:border-gold" required></textarea>
                        </div>
                        <div>
                            <label for="notification-target" class="block text-sm font-medium text-gray-700">Cible</label>
                            <select id="notification-target" class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-gold focus:border-gold">
                                <option value="all">Tous les utilisateurs</option>
                                <option value="senegal">Utilisateurs au Sénégal</option>
                                <option value="benin">Utilisateurs au Bénin</option>
                            </select>
                        </div>
                        <div class="flex justify-end pt-2">
                            <button type="submit" class="w-full px-4 py-2 bg-gold text-white font-bold rounded-lg hover:bg-yellow-600">
                                Envoyer la notification
                            </button>
                        </div>
                    </form>
                </section>
            </div>
        </div>
    </main>

    <!-- Conteneur pour les notifications toast -->
    <div id="toast-container" class="fixed bottom-5 right-5 z-50"></div>

    <script>
        // Script simple pour la gestion de l'interface
        document.addEventListener('DOMContentLoaded', () => {
            const saveButton = document.getElementById('save-aggregators');
            const notificationForm = document.getElementById('notification-form');
            const tabBtnPayments = document.getElementById('tab-btn-payments');
            const tabBtnAccounts = document.getElementById('tab-btn-accounts');
            const tabContentPayments = document.getElementById('tab-content-payments');
            const tabContentAccounts = document.getElementById('tab-content-accounts');
            const refreshTransactionsBtn = document.getElementById('refresh-transactions-btn');
            const exportOrdersBtn = document.getElementById('export-orders-btn');
            const salesChartContainer = document.getElementById('sales-chart-container');


            // NOUVEAU: Charger les paramètres au démarrage
            function loadPaymentSettings() {
                google.script.run
                    .withSuccessHandler(settings => {
                        // Cocher le bon bouton radio
                        if (settings.DEFAULT_AGGREGATOR === 'pawapay') {
                            document.getElementById('default-aggregator-pawapay').checked = true;
                        } else {
                            document.getElementById('default-aggregator-paydunya').checked = true;
                        }
                        // Remplir les champs de clés
                        document.getElementById('paydunya-master-key').value = settings.PAYDUNYA_MASTER_KEY || '';
                        document.getElementById('paydunya-private-key').value = settings.PAYDUNYA_PRIVATE_KEY || '';
                        document.getElementById('paydunya-token').value = settings.PAYDUNYA_TOKEN || '';
                        document.getElementById('pawapay-api-key').value = settings.PAWAPAY_API_KEY || '';
                        document.getElementById('pawapay-webhook-secret').value = settings.PAWAPAY_WEBHOOK_SECRET || '';
                    })
                    .withFailureHandler(err => showToast(`Erreur de chargement: ${err.message}`, true))
                    .getPaymentSettings();
            }

            // NOUVEAU: Sauvegarder les paramètres
            saveButton.addEventListener('click', (e) => {
                e.target.disabled = true;
                e.target.textContent = 'Sauvegarde...';

                const settingsToSave = {
                    DEFAULT_AGGREGATOR: document.querySelector('input[name="default-aggregator"]:checked').value,
                    PAYDUNYA_MASTER_KEY: document.getElementById('paydunya-master-key').value,
                    PAYDUNYA_PRIVATE_KEY: document.getElementById('paydunya-private-key').value,
                    PAYDUNYA_TOKEN: document.getElementById('paydunya-token').value,
                    PAWAPAY_API_KEY: document.getElementById('pawapay-api-key').value,
                    PAWAPAY_WEBHOOK_SECRET: document.getElementById('pawapay-webhook-secret').value,
                };

                google.script.run
                    .withSuccessHandler(response => {
                        showToast(response.message);
                        e.target.disabled = false;
                        e.target.textContent = 'Enregistrer les modifications';
                    })
                    .withFailureHandler(err => showToast(`Erreur: ${err.message}`, true))
                    .savePaymentSettings(settingsToSave);
            });

            // NOUVEAU: Charger les transactions récentes
            function loadRecentTransactions() {
                const container = document.getElementById('transactions-container');
                container.innerHTML = '<p class="text-center text-gray-500 py-4">Chargement des transactions...</p>';

                google.script.run
                    .withSuccessHandler(response => {
                        if (response.success && response.data.length > 0) {
                            const getStatusBadge = (status) => {
                                status = status.toLowerCase();
                                if (status.includes('payée') || status.includes('confirmée')) {
                                    return 'bg-green-100 text-green-800';
                                } else if (status.includes('attente')) {
                                    return 'bg-yellow-100 text-yellow-800';
                                } else if (status.includes('annulée') || status.includes('échoué')) {
                                    return 'bg-red-100 text-red-800';
                                }
                                return 'bg-gray-100 text-gray-800';
                            };

                            const statusOptions = ['Confirmée', 'En préparation', 'Expédiée', 'Livrée', 'Annulée'];

                            container.innerHTML = response.data.map(tx => `
                                <div class="border-b pb-3">
                                    <div class="flex justify-between items-center">
                                        <span class="font-bold text-sm">${tx.IDCommande}</span>
                                        <select 
                                            class="status-dropdown text-xs font-semibold p-1 border-0 rounded-md focus:ring-2 focus:ring-gold"
                                            data-order-id="${tx.IDCommande}"
                                            onchange="updateOrderStatus(this)"
                                        >
                                            ${statusOptions.map(opt => `<option value="${opt}" ${tx.Statut === opt ? 'selected' : ''}>${opt}</option>`).join('')}
                                        </select>
                                    </div>
                                    <div class="flex justify-between items-center text-xs text-gray-500 mt-1">
                                        <span>${new Date(tx.Date).toLocaleString('fr-FR')}</span>
                                        <span class="font-bold text-gray-800">${Number(tx.MontantTotal).toLocaleString('fr-FR')} F CFA via ${tx.MoyenPaiement}</span>
                                    </div>
                                </div>
                            `).join('');
                        } else if (response.success) {
                            container.innerHTML = '<p class="text-center text-gray-500 py-4">Aucune transaction récente trouvée.</p>';
                        } else {
                            throw new Error(response.error);
                        }
                    })
                    .withFailureHandler(err => {
                        container.innerHTML = `<p class="text-center text-red-500 py-4">Erreur: ${err.message}</p>`;
                    })
                    .getRecentTransactions();
            }

            // NOUVEAU: Gérer l'export CSV des commandes
            function handleExportOrders() {
                const btn = document.getElementById('export-orders-btn');
                const originalText = btn.innerHTML;
                btn.disabled = true;
                btn.innerHTML = '<span class="animate-spin h-5 w-5 border-2 border-white border-t-transparent rounded-full"></span><span class="ml-2">Export en cours...</span>';

                google.script.run
                    .withSuccessHandler(response => {
                        if (response.success) {
                            downloadCSV(response.csvData, 'export-commandes.csv');
                            showToast('Export des commandes réussi !');
                        } else {
                            throw new Error(response.error);
                        }
                    })
                    .withFailureHandler(err => showToast(`Erreur d'export: ${err.message}`, true))
                    .withFinally(() => {
                        btn.disabled = false;
                        btn.innerHTML = originalText;
                    })
                    .exportOrdersToCSV();
            }

            // NOUVEAU: Fonction utilitaire pour déclencher le téléchargement
            function downloadCSV(csvContent, fileName) {
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", fileName);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            // NOUVEAU: Charger et afficher le graphique des ventes
            function loadSalesChart() {
                const loader = document.getElementById('chart-loader');
                loader.style.display = 'flex';

                google.script.run
                    .withSuccessHandler(response => {
                        if (response.success) {
                            const ctx = document.getElementById('salesChart').getContext('2d');
                            new Chart(ctx, {
                                type: 'bar', // ou 'line'
                                data: {
                                    labels: response.labels,
                                    datasets: [{
                                        label: 'Ventes (F CFA)',
                                        data: response.data,
                                        backgroundColor: 'rgba(212, 175, 55, 0.6)', // Couleur or avec transparence
                                        borderColor: 'rgba(212, 175, 55, 1)',
                                        borderWidth: 1,
                                        borderRadius: 4,
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    scales: {
                                        y: {
                                            beginAtZero: true,
                                            ticks: {
                                                callback: function(value) {
                                                    return value.toLocaleString('fr-FR') + ' F';
                                                }
                                            }
                                        }
                                    },
                                    plugins: {
                                        legend: { display: false },
                                        tooltip: {
                                            callbacks: {
                                                label: function(context) {
                                                    return ` Ventes: ${context.raw.toLocaleString('fr-FR')} F CFA`;
                                                }
                                            }
                                        }
                                    }
                                }
                            });
                        } else { throw new Error(response.error); }
                    })
                    .withFailureHandler(err => {
                        salesChartContainer.innerHTML = `<p class="text-center text-red-500 py-4">Erreur de chargement du graphique: ${err.message}</p>`;
                    })
                    .withFinally(() => { loader.style.display = 'none'; })
                    .getSalesDataForChart();
            }

            notificationForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const title = document.getElementById('notification-title').value;
                const message = document.getElementById('notification-message').value;
                const target = document.getElementById('notification-target').value;

                console.log('Envoi de la notification :', { title, message, target });
                alert('La notification a été envoyée ! (Vérifiez la console)');
                // Ici, vous feriez un appel fetch() vers votre API backend pour envoyer la notification.
                notificationForm.reset();
            });

            // NOUVEAU: Logique pour les onglets
            function switchTab(tabName) {
                if (tabName === 'payments') {
                    tabBtnPayments.classList.add('active');
                    tabBtnAccounts.classList.remove('active');
                    tabContentPayments.classList.remove('hidden');
                    tabContentAccounts.classList.add('hidden');
                } else if (tabName === 'accounts') {
                    tabBtnPayments.classList.remove('active');
                    tabBtnAccounts.classList.add('active');
                    tabContentPayments.classList.add('hidden');
                    tabContentAccounts.classList.remove('hidden');
                    // Charger les utilisateurs si ce n'est pas déjà fait
                    loadUsers();
                }
            }

            tabBtnPayments.addEventListener('click', () => switchTab('payments'));
            tabBtnAccounts.addEventListener('click', () => switchTab('accounts'));

            // NOUVEAU: Fonction pour charger les utilisateurs (simulation)
            function loadUsers() {
                const usersTableBody = document.getElementById('users-table-body');
                // Simule un chargement. Dans la réalité, vous feriez un fetch vers votre API.
                console.log("Chargement de la liste des utilisateurs depuis le backend...");
                // usersTableBody.innerHTML = '<tr><td colspan="5" class="p-4 text-center">Chargement...</td></tr>';
                // Exemple: fetch(CONFIG.ACCOUNT_API_URL + '?action=getAllUsers').then(...)
            }

            // Charger les paramètres de paiement au démarrage de la page
            loadPaymentSettings();
            // Charger les transactions récentes au démarrage
            loadRecentTransactions();
            // Charger le graphique des ventes
            loadSalesChart();

            refreshTransactionsBtn.addEventListener('click', loadRecentTransactions);
            exportOrdersBtn.addEventListener('click', handleExportOrders);
        });
    </script>

</body>
</html>