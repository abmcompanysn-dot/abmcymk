<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <!-- Utilisation de Tailwind CSS via CDN pour un style rapide et responsive -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- NOUVEAU: Ajout de Chart.js pour les graphiques -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* Styles personnalisés pour une meilleure apparence dans la barre latérale de Google Sheets */
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      padding: 1rem;
      background-color: #f8f9fa;
    }
    .card {
      background-color: white;
      border-radius: 0.5rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .form-group {
      margin-bottom: 1.5rem;
    }
    .form-label {
      display: block;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: #495057;
    }
    .form-input {
      width: 100%;
      padding: 0.5rem 0.75rem;
      border: 1px solid #ced4da;
      border-radius: 0.25rem;
      transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }
    .form-input:focus {
      border-color: #80bdff;
      outline: 0;
      box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }
    .form-input:disabled {
      background-color: #e9ecef;
      opacity: 0.7;
    }
    .btn {
      display: inline-block;
      font-weight: 600;
      text-align: center;
      vertical-align: middle;
      cursor: pointer;
      border: 1px solid transparent;
      padding: 0.5rem 1rem;
      font-size: 1rem;
      border-radius: 0.25rem;
      transition: all 0.2s ease-in-out;
    }
    .btn-primary {
      color: #fff;
      background-color: #007bff;
      border-color: #007bff;
    }
    .btn-primary:hover {
      background-color: #0069d9;
      border-color: #0062cc;
    }
    .btn:disabled {
      opacity: 0.65;
      cursor: not-allowed;
    }
    #status {
      margin-top: 1rem;
      padding: 0.75rem;
      border-radius: 0.25rem;
      text-align: center;
      font-weight: 500;
    }
    .status-success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .status-error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    /* Styles pour les onglets */
    .tab-nav {
      display: flex;
      border-bottom: 1px solid #dee2e6;
      margin-bottom: 1.5rem;
      overflow-x: auto;
    }
    .tab-btn {
      padding: 0.75rem 1.5rem;
      font-weight: 600;
      color: #6c757d;
      background: none;
      border: none;
      border-bottom: 3px solid transparent;
      cursor: pointer;
      white-space: nowrap;
    }
    .tab-btn:hover {
      color: #007bff;
    }
    .tab-btn.active {
      color: #007bff;
      border-bottom-color: #007bff;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
      animation: fadeIn 0.3s;
    }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  </style>
</head>
<body>
  <div class="max-w-4xl mx-auto space-y-8">
    <div class="flex justify-between items-center">
      <h1 class="text-2xl font-bold text-gray-800">Tableau de Bord Administrateur</h1>
      <button id="export-csv-btn" class="btn btn-primary text-sm">Exporter les commandes (CSV)</button>
    </div>

    <!-- Navigation par onglets -->
    <div class="tab-nav">
      <button class="tab-btn active" onclick="switchTab('dashboard')">Tableau de bord</button>
      <button class="tab-btn" onclick="switchTab('clients')">Clients & Suivi</button>
      <button class="tab-btn" onclick="switchTab('account')">Gestion de Compte</button>
      <button class="tab-btn" onclick="switchTab('admin')">Admin. Générale</button>
    </div>

    <!-- Onglet 1: Tableau de bord (Contenu existant) -->
    <div id="tab-dashboard" class="tab-content active space-y-8">
    <!-- NOUVEAU: Section des statistiques -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div class="card p-4 text-center">
        <h3 class="text-sm font-semibold text-gray-500">Ventes Totales</h3>
        <p id="stats-total-sales" class="text-2xl font-bold text-gray-800 mt-1">Chargement...</p>
      </div>
      <div class="card p-4 text-center">
        <h3 class="text-sm font-semibold text-gray-500">Nombre de Commandes</h3>
        <p id="stats-order-count" class="text-2xl font-bold text-gray-800 mt-1">Chargement...</p>
      </div>
      <div class="card p-4 text-center">
        <h3 class="text-sm font-semibold text-gray-500">Nombre de Clients</h3>
        <p id="stats-user-count" class="text-2xl font-bold text-gray-800 mt-1">Chargement...</p>
      </div>
    </div>

    <!-- NOUVEAU: Section du graphique des ventes -->
    <div class="card p-6">
      <h2 class="text-xl font-semibold mb-4 text-gray-700">Ventes des 7 derniers jours</h2>
      <canvas id="salesChart"></canvas>
    </div>

    <!-- NOUVEAU: Section des transactions récentes -->
    <div class="card p-6">
      <h2 class="text-xl font-semibold mb-4 text-gray-700">Transactions en ligne récentes</h2>
      <div id="recent-transactions-container" class="overflow-x-auto">
        <p class="text-gray-500">Chargement des transactions...</p>
      </div>
    </div>
    </div>

    <!-- Onglet 2: Clients & Suivi -->
    <div id="tab-clients" class="tab-content space-y-8">
      <div class="card p-6">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-semibold text-gray-700">Suivi des Clients</h2>
          <button class="btn btn-primary text-sm">+ Ajouter un client</button>
        </div>
        <div class="mb-4">
          <input type="text" placeholder="Rechercher un client..." class="form-input">
        </div>
        <div class="overflow-x-auto">
          <table class="w-full text-sm text-left">
            <thead class="bg-gray-50">
              <tr>
                <th class="p-3 font-semibold">Nom</th>
                <th class="p-3 font-semibold">Email</th>
                <th class="p-3 font-semibold">Commandes</th>
                <th class="p-3 font-semibold">Total Dépensé</th>
                <th class="p-3 font-semibold">Dernière activité</th>
                <th class="p-3 font-semibold">Actions</th>
              </tr>
            </thead>
            <tbody id="clients-list-container">
              <tr>
                <td class="p-3" colspan="6" class="text-center text-gray-500">Chargement des clients...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Onglet 3: Gestion de Compte -->
    <div id="tab-account" class="tab-content space-y-8">
      <div class="card p-6">
        <h2 class="text-xl font-semibold mb-4 text-gray-700">Informations de l'Entreprise</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
          <div class="form-group">
            <label class="form-label">Nom de l'entreprise</label>
            <input type="text" class="form-input" value="Mon Entreprise" disabled>
          </div>
          <div class="form-group">
            <label class="form-label">Email de contact</label>
            <input type="email" class="form-input" value="contact@entreprise.com">
          </div>
        </div>
        <button class="btn btn-primary">Mettre à jour les infos</button>
      </div>

    <!-- Section de configuration des paiements -->
    <div class="card p-6">
      <h2 class="text-xl font-semibold mb-4 text-gray-700">Configuration des Paiements</h2>
      <form id="payment-form">
        <!-- Activation de Paydunya -->
        <div class="form-group">
          <label for="paydunya-active" class="form-label flex items-center cursor-pointer">
            <input type="checkbox" id="paydunya-active" class="h-4 w-4 text-gold focus:ring-gold border-gray-300 rounded">
            <span class="ml-2 text-gray-700">Activer le paiement par Paydunya</span>
          </label>
        </div>
        
        <!-- Section Paydunya -->
        <div id="paydunya-section" class="p-4 border rounded-lg mb-6">
          <h3 class="text-lg font-semibold mb-4 text-gray-700">Paydunya</h3>
          <div class="form-group">
            <label for="paydunya-master-key" class="form-label">Master Key</label>
            <input type="password" id="paydunya-master-key" class="form-input" placeholder="Votre clé maître Paydunya">
          </div>
          <div class="form-group">
            <label for="paydunya-private-key" class="form-label">Private Key (Live)</label>
            <input type="password" id="paydunya-private-key" class="form-input" placeholder="Votre clé privée live">
          </div>
          <div class="form-group">
            <label for="paydunya-token" class="form-label">Token</label>
            <input type="password" id="paydunya-token" class="form-input" placeholder="Votre token Paydunya">
          </div>
          <div class="form-group">
            <label for="paydunya-public-key" class="form-label">Public Key (Live)</label>
            <input type="password" id="paydunya-public-key" class="form-input" placeholder="Votre clé publique live">
          </div>
        </div>

        <button type="submit" id="save-button" class="btn btn-primary w-full">Enregistrer les modifications</button>
      </form>
    </div>
    </div>

    <!-- Onglet 4: Admin Générale (Gestion du site) -->
    <div id="tab-admin" class="tab-content space-y-8">
      <div class="card p-6">
        <h2 class="text-xl font-semibold mb-4 text-gray-700">Gestion des Pages du Site</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="p-4 border rounded hover:bg-gray-50 cursor-pointer transition">
            <h3 class="font-bold text-lg mb-2">Page d'Accueil</h3>
            <p class="text-sm text-gray-600">Modifier les bannières, les textes d'accueil et les sections mises en avant.</p>
          </div>
          <div class="p-4 border rounded hover:bg-gray-50 cursor-pointer transition">
            <h3 class="font-bold text-lg mb-2">Catalogue Produits</h3>
            <p class="text-sm text-gray-600">Ajouter, modifier ou supprimer des produits et des catégories.</p>
          </div>
          <div class="p-4 border rounded hover:bg-gray-50 cursor-pointer transition">
            <h3 class="font-bold text-lg mb-2">Galerie Photos</h3>
            <p class="text-sm text-gray-600">Gérer les photos de la galerie de l'entreprise.</p>
          </div>
          <div class="p-4 border rounded hover:bg-gray-50 cursor-pointer transition">
            <h3 class="font-bold text-lg mb-2">Paramètres SEO</h3>
            <p class="text-sm text-gray-600">Optimiser le référencement du site (Titres, Descriptions).</p>
          </div>
        </div>
      </div>
    </div>

    <div id="status" class="hidden"></div>
  </div>

  <script>
    const form = document.getElementById('payment-form');
    const saveButton = document.getElementById('save-button');
    const statusDiv = document.getElementById('status');
    const paydunyaActiveCheckbox = document.getElementById('paydunya-active');
    let salesChartInstance = null;

    // Fonction pour changer d'onglet
    function switchTab(tabId) {
      // Cacher tous les contenus
      document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
      // Désactiver tous les boutons
      document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
      
      // Activer l'onglet sélectionné
      document.getElementById('tab-' + tabId).classList.add('active');
      event.currentTarget.classList.add('active');
    }

    // Fonction pour afficher les messages de statut
    function showStatus(message, isError = false) {
      statusDiv.textContent = message;
      statusDiv.className = isError ? 'status-error' : 'status-success';
      statusDiv.classList.remove('hidden');
      setTimeout(() => statusDiv.classList.add('hidden'), 4000);
    }

    function togglePaydunyaSection() {
      const isChecked = paydunyaActiveCheckbox.checked;
      document.querySelectorAll('#paydunya-section input').forEach(input => input.disabled = !isChecked);
      document.getElementById('paydunya-section').style.opacity = isChecked ? '1' : '0.5';
    }

    // NOUVEAU: Fonction pour afficher les statistiques
    function renderStats(stats) {
        document.getElementById('stats-total-sales').textContent = `${(stats.totalSales || 0).toLocaleString('fr-FR')} F CFA`;
        document.getElementById('stats-order-count').textContent = stats.orderCount || 0;
        document.getElementById('stats-user-count').textContent = stats.userCount || 0;
    }

    // NOUVEAU: Fonction pour afficher le graphique des ventes
    function renderSalesChart(chartData) {
        const ctx = document.getElementById('salesChart').getContext('2d');
        if (salesChartInstance) {
            salesChartInstance.destroy();
        }
        salesChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: chartData.labels,
                datasets: [{
                    label: 'Ventes (F CFA)',
                    data: chartData.values,
                    backgroundColor: 'rgba(212, 175, 55, 0.6)',
                    borderColor: 'rgba(212, 175, 55, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: { y: { beginAtZero: true } }
            }
        });
    }

    // NOUVEAU: Fonction pour afficher les transactions récentes
    function renderRecentTransactions(transactions) {
        const container = document.getElementById('recent-transactions-container');
        if (!transactions || transactions.length === 0) {
            container.innerHTML = '<p class="text-gray-500">Aucune transaction en ligne récente.</p>';
            return;
        }
        const tableHTML = `
            <table class="w-full text-sm text-left">
                <thead class="bg-gray-50"><tr>
                    <th class="p-2 font-semibold">ID Commande</th>
                    <th class="p-2 font-semibold">Statut</th>
                    <th class="p-2 font-semibold text-right">Montant</th>
                </tr></thead>
                <tbody>${transactions.map(tx => `
                    <tr class="border-b">
                        <td class="p-2">${tx.IDCommande}</td>
                        <td class="p-2">${tx.Statut}</td>
                        <td class="p-2 text-right font-semibold">${Number(tx.MontantTotal).toLocaleString('fr-FR')} F</td>
                    </tr>`).join('')}
                </tbody>
            </table>`;
        container.innerHTML = tableHTML;
    }

    // Charger toutes les données au démarrage
    document.addEventListener('DOMContentLoaded', () => {
      showStatus('Chargement du tableau de bord...', false);
      google.script.run
        .withSuccessHandler(response => {
          if (response.success) {
            const data = response.data;
            // Rendu des différentes sections
            renderStats(data.stats);
            renderSalesChart(data.salesChartData);
            renderRecentTransactions(data.recentTransactions);

            // Remplissage des paramètres de paiement
            const settings = data.paymentSettings;
            document.getElementById('paydunya-master-key').value = settings.PAYDUNYA_MASTER_KEY || '';
            document.getElementById('paydunya-private-key').value = settings.PAYDUNYA_PRIVATE_KEY || '';
            document.getElementById('paydunya-token').value = settings.PAYDUNYA_TOKEN || '';
            document.getElementById('paydunya-public-key').value = settings.PAYDUNYA_PUBLIC_KEY || '';
            paydunyaActiveCheckbox.checked = settings.PAYDUNYA_ACTIVE || false;
            
            togglePaydunyaSection();
            showStatus('Tableau de bord chargé.', false);
          } else {
            throw new Error(response.error);
          }
        })
        .withFailureHandler(err => showStatus(`Erreur de chargement: ${err.message}`, true))
        .getDashboardData();
    });

    paydunyaActiveCheckbox.addEventListener('change', togglePaydunyaSection);

    // Gérer la soumission du formulaire de paiement
    form.addEventListener('submit', (e) => {
      e.preventDefault();
      saveButton.disabled = true;
      saveButton.textContent = 'Enregistrement...';
      showStatus('Sauvegarde en cours...', false);

      const settings = {
        PAYDUNYA_ACTIVE: paydunyaActiveCheckbox.checked,
        PAYDUNYA_MASTER_KEY: document.getElementById('paydunya-master-key').value,
        PAYDUNYA_PRIVATE_KEY: document.getElementById('paydunya-private-key').value,
        PAYDUNYA_TOKEN: document.getElementById('paydunya-token').value,
        PAYDUNYA_PUBLIC_KEY: document.getElementById('paydunya-public-key').value,
      };

      google.script.run
        .withSuccessHandler(response => {
          showStatus('Paramètres sauvegardés avec succès !', false);
          saveButton.disabled = false;
          saveButton.textContent = 'Enregistrer les modifications';
        })
        .withFailureHandler(err => {
          showStatus(`Erreur: ${err.message}`, true);
          saveButton.disabled = false;
          saveButton.textContent = 'Enregistrer les modifications';
        })
        .savePaymentSettings(settings);
    });

    // NOUVEAU: Gérer l'export CSV
    document.getElementById('export-csv-btn').addEventListener('click', () => {
        const btn = document.getElementById('export-csv-btn');
        btn.disabled = true;
        btn.textContent = 'Exportation...';

        google.script.run
            .withSuccessHandler(response => {
                if (response.success) {
                    const blob = new Blob([response.csvData], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement("a");
                    const url = URL.createObjectURL(blob);
                    link.setAttribute("href", url);
                    link.setAttribute("download", `export_commandes_${new Date().toISOString().split('T')[0]}.csv`);
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    showStatus('Exportation réussie.', false);
                } else {
                    throw new Error(response.error);
                }
                btn.disabled = false;
                btn.textContent = 'Exporter les commandes (CSV)';
            })
            .withFailureHandler(err => {
                showStatus(`Erreur d'exportation: ${err.message}`, true);
                btn.disabled = false;
                btn.textContent = 'Exporter les commandes (CSV)';
            })
            .exportOrdersToCSV();
    });
  </script>
</body>
</html>