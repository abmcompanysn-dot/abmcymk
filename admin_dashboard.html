<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <!-- Utilisation de Tailwind CSS via CDN pour un style rapide et responsive -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Styles personnalisés pour une meilleure apparence dans la barre latérale de Google Sheets */
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      padding: 1rem;
      background-color: #f8f9fa;
    }
    .form-group {
      margin-bottom: 1.5rem;
    }
    .form-label {
      display: block;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: #495057;
    }
    .form-input {
      width: 100%;
      padding: 0.5rem 0.75rem;
      border: 1px solid #ced4da;
      border-radius: 0.25rem;
      transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }
    .form-input:focus {
      border-color: #80bdff;
      outline: 0;
      box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }
    .form-input:disabled {
      background-color: #e9ecef;
      opacity: 0.7;
    }
    .btn {
      display: inline-block;
      font-weight: 600;
      text-align: center;
      vertical-align: middle;
      cursor: pointer;
      border: 1px solid transparent;
      padding: 0.5rem 1rem;
      font-size: 1rem;
      border-radius: 0.25rem;
      transition: all 0.2s ease-in-out;
    }
    .btn-primary {
      color: #fff;
      background-color: #007bff;
      border-color: #007bff;
    }
    .btn-primary:hover {
      background-color: #0069d9;
      border-color: #0062cc;
    }
    .btn:disabled {
      opacity: 0.65;
      cursor: not-allowed;
    }
    #status {
      margin-top: 1rem;
      padding: 0.75rem;
      border-radius: 0.25rem;
      text-align: center;
      font-weight: 500;
    }
    .status-success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .status-error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
  </style>
</head>
<body>
  <div class="max-w-2xl mx-auto">
    <h1 class="text-2xl font-bold mb-4 text-gray-800">Configuration des Paiements</h1>
    <p class="text-gray-600 mb-6">Gérez ici les clés API pour les services de paiement en ligne.</p>

    <form id="payment-form">
      <!-- Sélecteur de l'agrégateur par défaut -->
      <div class="form-group">
        <label for="default-aggregator" class="form-label">Service de Paiement par Défaut</label>
        <select id="default-aggregator" class="form-input">
          <option value="paydunya">Paydunya</option>
          <option value="pawapay">PawaPay</option>
        </select>
      </div>

      <!-- Section Paydunya -->
      <div id="paydunya-section" class="p-4 border rounded-lg mb-6">
        <h2 class="text-xl font-semibold mb-4 text-gray-700">Paydunya</h2>
        <div class="form-group">
          <label for="paydunya-master-key" class="form-label">Master Key</label>
          <input type="password" id="paydunya-master-key" class="form-input" placeholder="Votre clé maître Paydunya">
        </div>
        <div class="form-group">
          <label for="paydunya-private-key" class="form-label">Private Key (Live)</label>
          <input type="password" id="paydunya-private-key" class="form-input" placeholder="Votre clé privée live">
        </div>
        <div class="form-group">
          <label for="paydunya-token" class="form-label">Token</label>
          <input type="password" id="paydunya-token" class="form-input" placeholder="Votre token Paydunya">
        </div>
        <div class="form-group">
          <label for="paydunya-public-key" class="form-label">Public Key (Live)</label>
          <input type="password" id="paydunya-public-key" class="form-input" placeholder="Votre clé publique live">
        </div>
      </div>

      <!-- Section PawaPay -->
      <div id="pawapay-section" class="p-4 border rounded-lg mb-6">
        <h2 class="text-xl font-semibold mb-4 text-gray-700">PawaPay</h2>
        <div class="form-group">
          <label for="pawapay-api-key" class="form-label">API Key</label>
          <input type="password" id="pawapay-api-key" class="form-input" placeholder="Votre clé API PawaPay">
        </div>
        <div class="form-group">
          <label for="pawapay-webhook-secret" class="form-label">Webhook Secret</label>
          <input type="password" id="pawapay-webhook-secret" class="form-input" placeholder="Votre secret de webhook PawaPay">
        </div>
      </div>

      <button type="submit" id="save-button" class="btn btn-primary w-full">Enregistrer les modifications</button>
    </form>

    <div id="status" class="hidden"></div>
  </div>

  <script>
    const form = document.getElementById('payment-form');
    const saveButton = document.getElementById('save-button');
    const statusDiv = document.getElementById('status');
    const aggregatorSelect = document.getElementById('default-aggregator');

    // Fonction pour afficher les messages de statut
    function showStatus(message, isError = false) {
      statusDiv.textContent = message;
      statusDiv.className = isError ? 'status-error' : 'status-success';
    }

    // Fonction pour activer/désactiver les champs en fonction du choix
    function toggleSections() {
      const isPaydunya = aggregatorSelect.value === 'paydunya';
      document.querySelectorAll('#paydunya-section input').forEach(input => input.disabled = !isPaydunya);
      document.querySelectorAll('#pawapay-section input').forEach(input => input.disabled = isPaydunya);
      document.getElementById('paydunya-section').style.opacity = isPaydunya ? '1' : '0.5';
      document.getElementById('pawapay-section').style.opacity = isPaydunya ? '0.5' : '1';
    }

    // Charger les paramètres actuels au démarrage
    document.addEventListener('DOMContentLoaded', () => {
      showStatus('Chargement des paramètres...', false);
      google.script.run
        .withSuccessHandler(settings => {
          document.getElementById('paydunya-master-key').value = settings.PAYDUNYA_MASTER_KEY || '';
          document.getElementById('paydunya-private-key').value = settings.PAYDUNYA_PRIVATE_KEY || '';
          document.getElementById('paydunya-token').value = settings.PAYDUNYA_TOKEN || '';
          document.getElementById('paydunya-public-key').value = settings.PAYDUNYA_PUBLIC_KEY || '';
          document.getElementById('pawapay-api-key').value = settings.PAWAPAY_API_KEY || '';
          document.getElementById('pawapay-webhook-secret').value = settings.PAWAPAY_WEBHOOK_SECRET || '';
          aggregatorSelect.value = settings.DEFAULT_AGGREGATOR || 'paydunya';
          
          toggleSections(); // Appliquer l'état initial
          showStatus('Paramètres chargés.', false);
        })
        .withFailureHandler(err => showStatus(`Erreur de chargement: ${err.message}`, true))
        .getPaymentSettings();
    });

    // Gérer le changement de sélection
    aggregatorSelect.addEventListener('change', toggleSections);

    // Gérer la soumission du formulaire
    form.addEventListener('submit', (e) => {
      e.preventDefault();
      saveButton.disabled = true;
      saveButton.textContent = 'Enregistrement...';
      showStatus('Sauvegarde en cours...', false);

      const settings = {
        DEFAULT_AGGREGATOR: aggregatorSelect.value,
        PAYDUNYA_MASTER_KEY: document.getElementById('paydunya-master-key').value,
        PAYDUNYA_PRIVATE_KEY: document.getElementById('paydunya-private-key').value,
        PAYDUNYA_TOKEN: document.getElementById('paydunya-token').value,
        PAYDUNYA_PUBLIC_KEY: document.getElementById('paydunya-public-key').value,
        PAWAPAY_API_KEY: document.getElementById('pawapay-api-key').value,
        PAWAPAY_WEBHOOK_SECRET: document.getElementById('pawapay-webhook-secret').value,
      };

      google.script.run
        .withSuccessHandler(response => {
          showStatus('Paramètres sauvegardés avec succès !', false);
          saveButton.disabled = false;
          saveButton.textContent = 'Enregistrer les modifications';
        })
        .withFailureHandler(err => {
          showStatus(`Erreur: ${err.message}`, true);
          saveButton.disabled = false;
          saveButton.textContent = 'Enregistrer les modifications';
        })
        .savePaymentSettings(settings);
    });
  </script>
</body>
</html>