<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Confirmation Paiement Partenaire - ABMCY MARKET</title>
    <link rel="icon" href="https://i.postimg.cc/6QZBH1JJ/Sleek-Wordmark-Logo-for-ABMCY-MARKET.png" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f4f4f9; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #D4AF37;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div class="bg-white p-8 rounded-lg shadow-lg max-w-md w-full text-center">
        <img src="https://i.postimg.cc/6QZBH1JJ/Sleek-Wordmark-Logo-for-ABMCY-MARKET.png" alt="Logo" class="h-12 mx-auto mb-6">
        
        <h1 class="text-2xl font-bold text-gray-800 mb-2">Confirmation de Paiement</h1>
        <p class="text-gray-600 mb-6">Vérifiez la réception des fonds avant de confirmer.</p>

        <div id="loading" class="loader"></div>

        <div id="order-details" class="hidden text-left bg-gray-50 p-4 rounded-lg mb-6 border border-gray-200">
            <p class="mb-2"><strong>Commande :</strong> <span id="order-id">...</span></p>
            <p class="mb-2"><strong>Client :</strong> <span id="customer-name">...</span></p>
            <p class="mb-2"><strong>Montant :</strong> <span id="order-amount" class="text-xl font-bold text-green-600">...</span></p>
            <p class="mb-2"><strong>Date :</strong> <span id="order-date">...</span></p>
            <p><strong>Statut actuel :</strong> <span id="order-status" class="px-2 py-1 rounded text-xs font-bold">...</span></p>
        </div>

        <div id="actions" class="hidden space-y-3">
            <button onclick="confirmPayment()" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition shadow-md">
                ✅ J'ai reçu le paiement
            </button>
            <p class="text-xs text-gray-500 mt-2">En cliquant, le statut de la commande passera à "Payée et confirmée" et le client sera notifié.</p>
            
            <a href="dashboard-admin.html" class="block text-blue-600 hover:underline text-sm mt-4">Accéder à mon tableau de bord</a>
        </div>

        <div id="message" class="hidden mt-4 p-3 rounded text-sm font-semibold"></div>
    </div>

    <script>
        // URL de l'API Centrale
        const API_URL = "https://script.google.com/macros/s/AKfycbwz5kcckInIKs10_an7qbyt6uOdAGQWRJkU9lXobA36PeOi_-Ame8DuaFvxM3oHseaiRQ/exec";
        
        const params = new URLSearchParams(window.location.search);
        const orderId = params.get('orderId');

        document.addEventListener('DOMContentLoaded', loadOrderDetails);

        async function loadOrderDetails() {
            if (!orderId) {
                showError("Numéro de commande manquant.");
                return;
            }

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({ action: 'getOrderById', data: { orderId: orderId } })
                });
                const result = await response.json();

                document.getElementById('loading').classList.add('hidden');

                if (result.success && result.data) {
                    const order = result.data;
                    document.getElementById('order-details').classList.remove('hidden');
                    document.getElementById('actions').classList.remove('hidden');

                    document.getElementById('order-id').textContent = order.IDCommande;
                    
                    // Extraction du nom du client depuis les notes si nécessaire
                    let clientName = "Client";
                    if (order.Notes) {
                        const nameMatch = order.Notes.match(/Nom:\s*(.+)/);
                        if (nameMatch) clientName = nameMatch[1].split('\n')[0];
                    }
                    
                    document.getElementById('customer-name').textContent = clientName;
                    document.getElementById('order-amount').textContent = Number(order.MontantTotal).toLocaleString('fr-FR') + ' F CFA';
                    document.getElementById('order-date').textContent = new Date(order.Date).toLocaleDateString('fr-FR');
                    
                    const statusEl = document.getElementById('order-status');
                    statusEl.textContent = order.Statut;
                    
                    if (order.Statut === 'Payée et confirmée' || order.Statut === 'Livrée') {
                        statusEl.className = "px-2 py-1 rounded text-xs font-bold bg-green-100 text-green-800";
                        const btn = document.querySelector('button[onclick="confirmPayment()"]');
                        btn.disabled = true;
                        btn.textContent = "Déjà confirmé";
                        btn.classList.add('opacity-50', 'cursor-not-allowed');
                    } else {
                        statusEl.className = "px-2 py-1 rounded text-xs font-bold bg-yellow-100 text-yellow-800";
                    }

                } else {
                    showError("Commande introuvable.");
                }
            } catch (error) {
                document.getElementById('loading').classList.add('hidden');
                showError("Erreur de connexion.");
            }
        }

        async function confirmPayment() {
            if (!confirm("Confirmez-vous avoir reçu l'argent sur votre compte ?")) return;

            const btn = document.querySelector('button[onclick="confirmPayment()"]');
            btn.disabled = true;
            btn.textContent = "Traitement...";

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({ 
                        action: 'partnerConfirmPayment', // Action spécifique sans mot de passe admin
                        data: { orderId: orderId } 
                    })
                });
                const result = await response.json();

                if (result.success) {
                    showMessage("Paiement confirmé avec succès !", false);
                    document.getElementById('order-status').textContent = "Payée et confirmée";
                    document.getElementById('order-status').className = "px-2 py-1 rounded text-xs font-bold bg-green-100 text-green-800";
                    btn.textContent = "Confirmé ✅";
                } else {
                    showMessage("Erreur: " + result.error, true);
                    btn.disabled = false;
                    btn.textContent = "Réessayer";
                }
            } catch (error) {
                showMessage("Erreur de communication.", true);
                btn.disabled = false;
                btn.textContent = "Réessayer";
            }
        }

        function showError(msg) {
            const el = document.getElementById('message');
            el.textContent = msg;
            el.className = "mt-4 p-3 rounded text-sm font-semibold bg-red-100 text-red-700 block";
            el.classList.remove('hidden');
        }

        function showMessage(msg, isError) {
            const el = document.getElementById('message');
            el.textContent = msg;
            el.className = isError ? "mt-4 p-3 rounded text-sm font-semibold bg-red-100 text-red-700 block" : "mt-4 p-3 rounded text-sm font-semibold bg-green-100 text-green-700 block";
            el.classList.remove('hidden');
        }
    </script>
</body>
</html>