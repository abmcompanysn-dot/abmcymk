<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tableau de Bord - ABMCY MARKET</title>
    <link rel="icon" href="https://i.postimg.cc/6QZBH1JJ/Sleek-Wordmark-Logo-for-ABMCY-MARKET.png" type="image/png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #1a1a1a;
            --background-color: #ffffff;
            --sidebar-bg: #1f1f1f;
            --light-gray: #f4f4f9;
            --text-color: #333;
            --accent-color: #007bff;
            --danger-color: #dc3545;
            --success-color: #28a745;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--light-gray);
            margin: 0;
            display: flex;
            min-height: 100vh;
            overflow-x: hidden; /* Emp√™che le d√©filement horizontal ind√©sirable */
            width: 100%;
        }

        /* --- Sidebar --- */
        .sidebar {
            width: 250px;
            background-color: var(--sidebar-bg);
            color: #f1f1f1;
            display: flex;
            flex-direction: column;
            padding: 1.5rem 0;
        }
        .sidebar-header {
            padding: 0 1.5rem;
            margin-bottom: 2rem;
            font-size: 1.2rem;
            font-weight: 600;
            display: flex;
            align-items: center;
        }
        .sidebar-nav ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .sidebar-nav a {
            display: block;
            padding: 1rem 1.5rem;
            color: #f1f1f1;
            text-decoration: none;
            transition: background-color 0.2s;
        }
        .sidebar-nav a:hover, .sidebar-nav a.active {
            background-color: rgba(255, 255, 255, 0.1);
        }

        /* --- Main Content --- */
        .main-content {
            flex-grow: 1;
            padding: 2rem;
            overflow-y: auto;
        }
        .main-header {
            margin-bottom: 2rem;
        }
        .main-header h1 {
            margin: 0;
            color: var(--primary-color);
        }

        /* --- Sections & Cards --- */
        .section {
            background: var(--background-color);
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            margin-bottom: 2rem;
        }
        .section h2 {
            margin-top: 0;
            border-bottom: 1px solid #eee;
            padding-bottom: 0.8rem;
            margin-bottom: 1.5rem;
        }

        /* --- Forms --- */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            align-items: flex-end;
        }
        .input-group {
            display: flex;
            flex-direction: column;
        }
        .input-group label {
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            font-weight: 500;
        }
        .input-group input {
            padding: 0.7rem;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 1rem;
        }
        .submit-btn {
            padding: 0.7rem 1.5rem;
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            height: fit-content;
        }

        /* --- Items List --- */
        .items-list {
            margin-top: 2rem;
        }
        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid #eee;
        }
        .list-item:last-child {
            border-bottom: none;
        }
        .item-details {
            font-weight: 500;
        }
        .item-price {
            color: var(--accent-color);
            margin-left: 1rem;
        }
        .item-actions button {
            background: none;
            border: 1px solid;
            padding: 0.3rem 0.8rem;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 0.5rem;
        }
        .delete-btn {
            color: var(--danger-color);
            border-color: var(--danger-color);
        }
        .edit-btn {
            color: var(--accent-color);
            border-color: var(--accent-color);
        }
        .stock-btn {
            color: #28a745;
            border-color: #28a745;
        }

        #loader {
            text-align: center;
            font-size: 1.2rem;
            padding: 2rem;
        }

        /* --- QR Code Section --- */
        #qrCodeContainer {
            text-align: center;
        }
        #qrCodeContainer canvas {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
        }

        /* --- Preview Images --- */
        .img-preview {
            max-width: 100px;
            max-height: 100px;
            margin-top: 10px;
            border-radius: 4px;
            border: 1px solid #ddd;
            display: none; /* Cach√© par d√©faut */
        }

        /* --- Responsive & Mobile --- */
        .mobile-toggle {
            display: none;
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 1001;
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .item-thumb {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 6px;
            margin-right: 1rem;
            border: 1px solid #eee;
        }
        
        .item-info {
            display: flex;
            align-items: center;
        }

        @media (max-width: 768px) {
            .sidebar { position: fixed; left: -260px; top: 0; bottom: 0; z-index: 1000; transition: left 0.3s ease; box-shadow: 2px 0 10px rgba(0,0,0,0.1); }
            .sidebar.open { left: 0; }
            .main-content { padding: 1rem; padding-top: 5rem; width: 100%; }
            .mobile-toggle { display: block; }
            .form-grid { grid-template-columns: 1fr; }
            .list-item { flex-direction: column; align-items: flex-start; gap: 1rem; }
            .item-actions { align-self: flex-end; }
            
            /* Overlay pour le menu mobile */
            #sidebar-overlay {
                display: none;
                position: fixed;
                top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.5);
                z-index: 999;
                backdrop-filter: blur(2px);
            }
            #sidebar-overlay.visible { display: block; }
        }

        /* --- Logs Table --- */
        .logs-table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        .logs-table th, .logs-table td { padding: 0.8rem; text-align: left; border-bottom: 1px solid #eee; }
        .logs-table th { background-color: #f8f9fa; font-weight: 600; }
        .logs-table tr:hover { background-color: #f1f1f1; }
        .log-date { color: #666; font-size: 0.9em; white-space: nowrap; }
        .log-action { font-weight: 500; }
        .log-details { color: #555; font-size: 0.9em; }
        
        /* Badge pour le type d'action */
        .badge { padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.8em; color: white; }
        .badge-add { background-color: var(--success-color); }
        .badge-edit { background-color: var(--accent-color); }
        .badge-delete { background-color: var(--danger-color); }

        /* --- Password Toggle --- */
        .password-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }
        .toggle-password {
            position: absolute;
            right: 10px;
            cursor: pointer;
            font-size: 1.2rem;
            user-select: none;
        }

        /* --- Public Link Section (Professional Style) --- */
        .share-container {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 2rem;
            margin-top: 1rem;
            display: flex;
            flex-direction: column;
            gap: 2rem;
            align-items: center;
        }
        
        @media (min-width: 768px) {
            .share-container {
                flex-direction: row;
                align-items: flex-start;
            }
        }

        .qr-wrapper {
            background: white;
            padding: 1rem;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            text-align: center;
            border: 1px solid #eee;
        }

        .link-details {
            flex: 1;
            width: 100%;
        }

        .link-box {
            display: flex;
            background: white;
            border: 1px solid #ced4da;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        }

        .link-box input {
            flex: 1;
            border: none;
            padding: 1rem;
            font-family: 'Courier New', monospace;
            color: #495057;
            background: transparent;
            outline: none;
            font-size: 0.95rem;
        }

        .copy-btn {
            background: #f8f9fa;
            border: none;
            border-left: 1px solid #ced4da;
            padding: 0 1.5rem;
            cursor: pointer;
            font-weight: 600;
            color: var(--primary-color);
            transition: all 0.2s;
        }

        .copy-btn:hover {
            background: #e2e6ea;
            color: var(--accent-color);
        }
        
        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
            padding: 0.7rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
            text-decoration: none;
        }

        .btn-outline:hover {
            background: var(--primary-color);
            color: white;
        }
    </style>
</head>
<body>
    <button class="mobile-toggle" onclick="toggleSidebar()">‚ò∞ Menu</button>
    <div id="sidebar-overlay" onclick="toggleSidebar()"></div>

    <aside class="sidebar">
        <div class="sidebar-header">
            <img id="sidebar-logo" src="" alt="" style="width: 30px; height: 30px; border-radius: 50%; margin-right: 10px; display: none; object-fit: cover;">
            <span>ABMCY</span>
        </div>
        <nav class="sidebar-nav">
            <ul>
                <li><a href="#" onclick="showSection('dashboard')" id="nav-dashboard" class="active">Tableau de Bord</a></li>
                <li><a href="#" onclick="showSection('orders')" id="nav-orders">Commandes & Clients</a></li>
                <li><a href="#" onclick="showSection('reviews')" id="nav-reviews">Avis Clients</a></li>
                <li><a href="#" onclick="showSection('logs')" id="nav-logs">Journal d'activit√©</a></li>
                <li><a href="#" onclick="showSection('settings')" id="nav-settings">Param√®tres</a></li>
                <li><a href="#" onclick="logout()" id="nav-logout" style="color: #dc3545;">D√©connexion</a></li>
            </ul>
        </nav>
    </aside>

    <main class="main-content">
        <header class="main-header">
            <h1>Tableau de Bord</h1>
            <p>G√©rez vos services, produits et informations ici.</p>
        </header>

        <div id="loader">Chargement des donn√©es...</div>

        <div id="dashboard-content" style="display: none;">
            <!-- Section pour g√©rer les services -->
            <section class="section">
                <h2>G√©rer les Services</h2>
                <form id="addServiceForm" class="form-grid">
                    <input type="hidden" id="serviceId">
                    <div class="input-group">
                        <label for="serviceName">Nom du service</label>
                        <input type="text" id="serviceName" required>
                    </div>
                    <div class="input-group">
                        <label for="servicePrice">Prix (FCFA)</label>
                        <input type="number" id="servicePrice" required>
                    </div>
                    <div class="input-group">
                        <label for="serviceCategory">Cat√©gorie</label>
                        <input type="text" id="serviceCategory" placeholder="ex: Coupe, Soin...">
                    </div>
                    <div class="input-group">
                        <label for="serviceCharacteristics">Caract√©ristiques</label>
                        <input type="text" id="serviceCharacteristics" placeholder="ex: Tendance, Bio...">
                    </div>
                    <div class="input-group">
                        <label for="serviceImage">Image (Optionnel)</label>
                        <input type="file" id="serviceImage" accept="image/*">
                    </div>
                    <div class="input-group" style="grid-column: 1 / -1;">
                        <label for="serviceDescription">Description</label>
                        <textarea id="serviceDescription" rows="2" style="width: 100%; padding: 0.7rem; border: 1px solid #ccc; border-radius: 6px; font-family: inherit;"></textarea>
                    </div>
                    <button type="submit" class="submit-btn">Ajouter / Modifier</button>
                </form>
                <div id="servicesList" class="items-list">
                    <!-- Les services seront inject√©s ici par JavaScript -->
                </div>
            </section>

            <!-- Section pour g√©rer les produits -->
            <section class="section">
                <h2>G√©rer les Produits</h2>
                <form id="addProductForm" class="form-grid">
                    <input type="hidden" id="productId">
                    <div class="input-group">
                        <label for="productName">Nom du produit</label>
                        <input type="text" id="productName" required>
                    </div>
                    <div class="input-group">
                        <label for="productPrice">Prix (FCFA)</label>
                        <input type="number" id="productPrice" required>
                    </div>
                    <div class="input-group">
                        <label for="productCategory">Cat√©gorie</label>
                        <input type="text" id="productCategory" placeholder="ex: Shampoing, Accessoire...">
                    </div>
                    <div class="input-group">
                        <label for="productCharacteristics">Caract√©ristiques</label>
                        <input type="text" id="productCharacteristics" placeholder="ex: Hydratant, 200ml...">
                    </div>
                    <div class="input-group">
                        <label for="productStock">Stock</label>
                        <input type="number" id="productStock" value="0">
                    </div>
                    <div class="input-group">
                        <label for="productImage">Image (Optionnel)</label>
                        <input type="file" id="productImage" accept="image/*">
                    </div>
                    <div class="input-group" style="grid-column: 1 / -1;">
                        <label for="productDescription">Description</label>
                        <textarea id="productDescription" rows="2" style="width: 100%; padding: 0.7rem; border: 1px solid #ccc; border-radius: 6px; font-family: inherit;"></textarea>
                    </div>
                    <button type="submit" class="submit-btn">Ajouter / Modifier</button>
                </form>
                <div id="productsList" class="items-list">
                    <!-- Les produits seront inject√©s ici par JavaScript -->
                </div>
            </section>

            <!-- Section pour le QR Code et le lien public -->
            <section class="section">
                <h2>Votre Vitrine en Ligne</h2>
                <p>Voici le lien unique vers votre boutique professionnelle. Partagez-le sur vos r√©seaux sociaux (Instagram, WhatsApp, Facebook) pour permettre √† vos clients de r√©server.</p>
                
                <div class="share-container">
                    <div class="qr-wrapper">
                        <div id="qrCodeContainer"></div>
                        <p style="margin-top: 0.8rem; font-size: 0.85rem; color: #666; font-weight: 500;">Scannez pour visiter</p>
                        <button onclick="downloadQrCode()" style="margin-top: 0.5rem; font-size: 0.8rem; color: var(--accent-color); background: none; border: none; cursor: pointer; text-decoration: underline;">T√©l√©charger PNG</button>
                    </div>
                    
                    <div class="link-details">
                        <label style="display:block; margin-bottom:0.8rem; font-weight:600; color:#333;">
                            Lien public officiel
                            <button onclick="editSlug()" style="all: unset; cursor: pointer; color: var(--accent-color); font-size: 0.8em; margin-left: 10px; font-weight: normal;">(Modifier)</button>
                        </label>
                        <div class="link-box">
                            <input type="text" id="publicLinkInput" readonly>
                            <button class="copy-btn" onclick="copyLink()">Copier</button>
                        </div>
                        <div id="visitStats" style="display:none; margin-bottom: 1.5rem; color: #666; font-size: 0.9rem; background: #fff; padding: 8px 12px; border-radius: 6px; border: 1px solid #eee; display: inline-block;">
                            üìä <span id="visitCount" style="font-weight:bold; color: var(--primary-color);">0</span> visites sur ce lien
                        </div>
                        
                        <div class="chart-container" style="position: relative; height: 200px; width: 100%; margin-bottom: 1.5rem; display: none;" id="chartWrapper">
                            <canvas id="visitsChart"></canvas>
                        </div>
                        
                        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                            <a id="previewBtn" href="#" target="_blank" class="submit-btn" style="text-decoration: none; display: inline-flex; align-items: center; gap: 0.5rem;">
                                <span>üöÄ</span> Visiter ma page
                            </a>
                            <button onclick="shareNative()" class="btn-outline">
                                <span>üì§</span> Partager
                            </button>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <!-- NOUVEAU: Section Commandes & Clients -->
        <div id="orders-content" style="display: none;">
            <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem; border-bottom: 1px solid #eee; padding-bottom: 1rem; overflow-x: auto;">
                <button onclick="switchOrderTab('overview')" id="tab-overview" class="submit-btn" style="background-color: var(--primary-color);">Vue d'ensemble</button>
                <button onclick="switchOrderTab('orders')" id="tab-orders-list" class="submit-btn" style="background-color: #6c757d;">Commandes</button>
                <button onclick="switchOrderTab('clients')" id="tab-clients-list" class="submit-btn" style="background-color: #6c757d;">Clients</button>
            </div>

            <!-- Sous-section Vue d'ensemble (Stats) -->
            <section id="overview-section" class="section">
                <h2>Performances</h2>
                <div class="stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                    <div class="stat-card" style="background: #fff; padding: 1.5rem; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border-left: 4px solid var(--accent-color);">
                        <h3 style="margin: 0 0 0.5rem 0; font-size: 0.9rem; color: #666;">Chiffre d'Affaires</h3>
                        <p id="stat-revenue" style="font-size: 1.8rem; font-weight: bold; color: #333; margin: 0;">0 F</p>
                    </div>
                    <div class="stat-card" style="background: #fff; padding: 1.5rem; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border-left: 4px solid var(--success-color);">
                        <h3 style="margin: 0 0 0.5rem 0; font-size: 0.9rem; color: #666;">Commandes</h3>
                        <p id="stat-orders" style="font-size: 1.8rem; font-weight: bold; color: #333; margin: 0;">0</p>
                    </div>
                    <div class="stat-card" style="background: #fff; padding: 1.5rem; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border-left: 4px solid #fd7e14;">
                        <h3 style="margin: 0 0 0.5rem 0; font-size: 0.9rem; color: #666;">Clients Uniques</h3>
                        <p id="stat-clients" style="font-size: 1.8rem; font-weight: bold; color: #333; margin: 0;">0</p>
                    </div>
                    <div class="stat-card" style="background: #fff; padding: 1.5rem; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border-left: 4px solid #6f42c1;">
                        <h3 style="margin: 0 0 0.5rem 0; font-size: 0.9rem; color: #666;">Panier Moyen</h3>
                        <p id="stat-aov" style="font-size: 1.8rem; font-weight: bold; color: #333; margin: 0;">0 F</p>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem;">
                    <div style="background: #fff; padding: 1.5rem; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                        <h3 style="margin-top: 0; margin-bottom: 1rem; font-size: 1.1rem;">√âvolution des Ventes</h3>
                        <div style="height: 300px;"><canvas id="salesChart"></canvas></div>
                    </div>
                    <div style="background: #fff; padding: 1.5rem; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                        <h3 style="margin-top: 0; margin-bottom: 1rem; font-size: 1.1rem;">Statut des Commandes</h3>
                        <div style="height: 300px; display: flex; justify-content: center;"><canvas id="statusChart"></canvas></div>
                    </div>
                </div>
            </section>

            <!-- Sous-section Commandes -->
            <section id="orders-section" class="section" style="display: none;">
                <h2>Gestion des Commandes</h2>
                <div style="display: flex; flex-wrap: wrap; gap: 1rem; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <div style="display: flex; gap: 0.5rem; flex-grow: 1;">
                        <input type="text" id="orderSearch" placeholder="Rechercher (ID, Client)..." onkeyup="filterOrders()" style="padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px; width: 100%; max-width: 300px;">
                        <select id="orderStatusFilter" onchange="filterOrders()" style="padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px;">
                            <option value="">Tous les statuts</option>
                            <option value="En attente">En attente</option>
                            <option value="En cours">En cours</option>
                            <option value="Livr√©e">Livr√©e</option>
                            <option value="Annul√©e">Annul√©e</option>
                        </select>
                    </div>
                    <button onclick="fetchOrders()" class="submit-btn" style="padding: 0.5rem 1rem; font-size: 0.9rem;">Rafra√Æchir</button>
                </div>
                <div style="overflow-x: auto;">
                    <table class="logs-table" id="ordersTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Date</th>
                                <th>Client</th>
                                <th>Montant</th>
                                <th>Paiement</th>
                                <th>Statut</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="ordersTableBody">
                            <!-- Les commandes seront inject√©es ici -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Sous-section Clients -->
            <section id="clients-section" class="section" style="display: none;">
                <h2>Liste des Clients</h2>
                <p>Clients ayant pass√© commande chez vous.</p>
                <div style="overflow-x: auto;">
                    <table class="logs-table">
                        <thead>
                            <tr>
                                <th>Nom</th>
                                <th>Email</th>
                                <th>T√©l√©phone</th>
                                <th>Ville/Adresse</th>
                                <th>Commandes</th>
                            </tr>
                        </thead>
                        <tbody id="clientsTableBody">
                            <!-- Les clients seront inject√©s ici -->
                        </tbody>
                    </table>
                </div>
            </section>
        </div>

        <!-- NOUVEAU: Section Journal d'activit√© (Logs) -->
        <div id="logs-content" style="display: none;">
            <section class="section">
                <h2>Journal d'activit√©</h2>
                <p>Historique des actions effectu√©es sur votre compte.</p>
                <div style="overflow-x: auto;">
                    <table class="logs-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Action</th>
                                <th>D√©tails</th>
                            </tr>
                        </thead>
                        <tbody id="logsTableBody">
                            <!-- Les logs seront inject√©s ici -->
                        </tbody>
                    </table>
                </div>
            </section>
        </div>

        <!-- NOUVEAU: Section Avis Clients -->
        <div id="reviews-content" style="display: none;">
            <section class="section">
                <h2>Avis Clients</h2>
                <p>G√©rez les avis laiss√©s par vos clients. Activez "Visible" pour les afficher sur votre page publique.</p>
                <div id="reviewsList" class="items-list"></div>
            </section>
        </div>

        <!-- NOUVEAU: Section Param√®tres -->
        <div id="settings-content" style="display: none;">
            <section class="section">
                <h2>Configuration de l'entreprise</h2>
                <form id="settingsForm" class="form-grid" style="grid-template-columns: 1fr;">
                    <div class="input-group">
                        <label for="settingsName">Nom de l'entreprise</label>
                        <input type="text" id="settingsName" required>
                    </div>
                    <div class="input-group">
                        <label for="settingsSlug">Identifiant personnalis√© (Lien court)</label>
                        <input type="text" id="settingsSlug" placeholder="ex: mon-salon-elegance" pattern="[a-zA-Z0-9\-]+" title="Lettres, chiffres et tirets uniquement">
                        <small id="slug-feedback" style="font-size: 0.8em; min-height: 1em; margin-top: 4px; font-weight: 600;"></small>
                        <small style="color: #666; font-size: 0.8em;">Sera utilis√© pour votre lien : .../babershop.html?alias=<b>votre-identifiant</b></small>
                    </div>
                    <div class="input-group">
                        <label for="settingsDesc">Description</label>
                        <textarea id="settingsDesc" rows="4" style="padding: 0.7rem; border: 1px solid #ccc; border-radius: 6px; font-family: inherit;"></textarea>
                    </div>
                    <div class="input-group">
                        <label for="settingsPhone">T√©l√©phone</label>
                        <input type="text" id="settingsPhone">
                    </div>
                    <div class="input-group">
                        <label for="settingsAddress">Adresse</label>
                        <input type="text" id="settingsAddress">
                    </div>

                    <div class="input-group">
                        <label for="settingsWaveUrl">Lien de paiement Wave (Optionnel)</label>
                        <input type="text" id="settingsWaveUrl" placeholder="ex: https://pay.wave.com/m/..." style="font-family: monospace; font-size: 0.9em;">
                        <small style="color: #666; font-size: 0.8em;">Si renseign√©, les paiements Wave iront directement sur ce compte. Sinon, ils passeront par ABMCY.</small>
                    </div>
                    
                    <div class="input-group">
                        <label for="settingsLogo">Logo (Image de profil)</label>
                        <input type="file" id="settingsLogo" accept="image/*">
                        <img id="previewLogo" class="img-preview" alt="Aper√ßu Logo">
                        <input type="hidden" id="currentLogoUrl">
                    </div>

                    <div class="input-group">
                        <label for="settingsCover">Image de couverture (Page d'accueil)</label>
                        <input type="file" id="settingsCover" accept="image/*">
                        <img id="previewCover" class="img-preview" alt="Aper√ßu Couverture">
                        <input type="hidden" id="currentCoverUrl">
                    </div>

                    <button type="submit" class="submit-btn" style="margin-top: 1rem;">Enregistrer les modifications</button>
                </form>
            </section>

            <!-- NOUVEAU: Section Changement de mot de passe -->
            <section class="section">
                <h2>S√©curit√©</h2>
                <form id="changePasswordForm" class="form-grid" style="grid-template-columns: 1fr;">
                    <div class="input-group">
                        <label for="currentPassword">Mot de passe actuel</label>
                        <div class="password-wrapper">
                            <input type="password" id="currentPassword" required autocomplete="current-password">
                            <span class="toggle-password" onclick="togglePassword('currentPassword', this)">üëÅÔ∏è</span>
                        </div>
                    </div>
                    <div class="input-group">
                        <label for="newPassword">Nouveau mot de passe</label>
                        <div class="password-wrapper">
                            <input type="password" id="newPassword" required minlength="8" placeholder="8+ chars, Maj, Min, Chiffre, Symbole" autocomplete="new-password">
                            <span class="toggle-password" onclick="togglePassword('newPassword', this)">üëÅÔ∏è</span>
                        </div>
                    </div>
                    <div class="input-group">
                        <label for="confirmNewPassword">Confirmer le nouveau mot de passe</label>
                        <div class="password-wrapper">
                            <input type="password" id="confirmNewPassword" required minlength="8" autocomplete="new-password">
                            <span class="toggle-password" onclick="togglePassword('confirmNewPassword', this)">üëÅÔ∏è</span>
                        </div>
                    </div>
                    <button type="submit" class="submit-btn" style="margin-top: 1rem; background-color: #6c757d;">Changer le mot de passe</button>
                </form>
            </section>
        </div>
    </main>

    <!-- Modal D√©tails Commande -->
    <div id="order-modal" style="display: none; position: fixed; inset: 0; z-index: 2000; align-items: center; justify-content: center; background: rgba(0,0,0,0.5);">
        <div style="background: white; border-radius: 12px; padding: 2rem; width: 90%; max-width: 700px; max-height: 90vh; overflow-y: auto; position: relative; box-shadow: 0 10px 25px rgba(0,0,0,0.2);">
            <button onclick="closeOrderModal()" style="position: absolute; top: 1rem; right: 1rem; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666;">&times;</button>
            <h3 style="margin-top: 0; margin-bottom: 1.5rem; font-size: 1.5rem; color: var(--primary-color);">D√©tails de la Commande <span id="modalOrderId" style="color: var(--accent-color);"></span></h3>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 2rem; margin-bottom: 2rem;">
                <div>
                    <h4 style="border-bottom: 2px solid #f4f4f9; padding-bottom: 0.5rem; margin-bottom: 1rem;">Informations Client</h4>
                    <p><strong>Nom:</strong> <span id="modalClientName"></span></p>
                    <p><strong>Email:</strong> <span id="modalClientEmail"></span></p>
                    <p><strong>T√©l√©phone:</strong> <span id="modalClientPhone"></span></p>
                    <p><strong>Adresse:</strong> <span id="modalClientAddress"></span></p>
                    <p><strong>Note:</strong> <span id="modalClientNote" style="font-style: italic;"></span></p>
                </div>
                <div>
                    <h4 style="border-bottom: 2px solid #f4f4f9; padding-bottom: 0.5rem; margin-bottom: 1rem;">Info Commande</h4>
                    <p><strong>Date:</strong> <span id="modalOrderDate"></span></p>
                    <p><strong>Montant Total:</strong> <span id="modalOrderTotal" style="color: var(--success-color); font-weight: bold;"></span></p>
                    <p><strong>Type Paiement:</strong> <span id="modalPaymentType" class="badge" style="background-color: #6c757d;"></span></p>
                    <div style="margin-top: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Statut Actuel</label>
                        <select id="modalOrderStatus" style="width: 100%; padding: 0.7rem; border: 1px solid #ccc; border-radius: 6px; margin-bottom: 0.5rem;">
                            <option value="En attente">En attente</option>
                            <option value="En cours">En cours</option>
                            <option value="Livr√©e">Livr√©e</option>
                            <option value="Annul√©e">Annul√©e</option>
                        </select>
                        <button onclick="updateOrderStatus()" class="submit-btn" style="width: 100%;">Mettre √† jour le statut</button>
                    </div>
                </div>
            </div>

            <h4 style="border-bottom: 2px solid #f4f4f9; padding-bottom: 0.5rem; margin-bottom: 1rem;">Articles Command√©s</h4>
            <div id="modalOrderItems" style="display: flex; flex-direction: column; gap: 0.8rem;"></div>
        </div>
    </div>

    <!-- Import des fonctions admin (ImgBB) -->
    <script src="admin_functions.js"></script>
    <script src="../js/main.js"></script>
    <!-- Import de la configuration centralis√©e -->
    <script src="main-entreprise.js"></script>
    <!-- Import de Chart.js pour le graphique -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <script>
        // URL de l'API sp√©cifique au type (Produits/Services)
        let BUSINESS_API_URL = ""; 
        // URL de l'API Centrale (Infos entreprise) - R√©cup√©r√©e depuis admin_functions.js
        const CENTRAL_API_URL = CONFIG.ACCOUNT_API_URL;

        // Librairie pour g√©n√©rer le QR Code
        const script = document.createElement('script');
        script.src = "https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.5.1/qrcode.min.js";
        document.head.appendChild(script);

        const loader = document.getElementById('loader');
        const dashboardContent = document.getElementById('dashboard-content');
        const settingsContent = document.getElementById('settings-content');
        const logsContent = document.getElementById('logs-content');
        const ordersContent = document.getElementById('orders-content');
        const reviewsContent = document.getElementById('reviews-content');
        const servicesListDiv = document.getElementById('servicesList');
        const productsListDiv = document.getElementById('productsList');

        let compteId = null;
        let currentServices = [];
        let currentProducts = [];
        let currentSlug = null; // Stocker le slug actuel

        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            sidebar.classList.toggle('open');
            overlay.classList.toggle('visible');
        }

        function togglePassword(inputId, icon) {
            const input = document.getElementById(inputId);
            if (input.type === "password") {
                input.type = "text";
                icon.textContent = "üôà";
            } else {
                input.type = "password";
                icon.textContent = "üëÅÔ∏è";
            }
        }

        function editSlug() {
            // S'assurer que la section des param√®tres est visible
            showSection('settings');
            
            const slugInput = document.getElementById('settingsSlug');
            slugInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
            slugInput.focus();
            
            // Mettre en surbrillance l'input pour attirer l'attention
            slugInput.style.transition = 'all 0.3s';
            slugInput.style.boxShadow = '0 0 0 3px rgba(0, 123, 255, 0.3)';
            setTimeout(() => {
                slugInput.style.boxShadow = '';
            }, 2000);
        }

        document.addEventListener('DOMContentLoaded', () => {
            // 1. R√©cup√©rer l'ID du compte depuis l'URL
            const params = new URLSearchParams(window.location.search);
            compteId = params.get('compteId');

            if (!compteId) {
                loader.textContent = "Erreur : ID de compte manquant. Impossible de charger le tableau de bord.";
                return;
            }
            
            // 2. Charger les donn√©es initiales
            // NOUVEAU: Charger les donn√©es locales pour un affichage imm√©diat
            loadLocalData();
            
            setupImagePreviews();
            fetchData();
            setupQrCodeAndLink();
        });

        // Gestion de la navigation
        function showSection(sectionId) {
            // Cacher toutes les sections
            dashboardContent.style.display = 'none';
            settingsContent.style.display = 'none';
            logsContent.style.display = 'none';
            ordersContent.style.display = 'none';
            reviewsContent.style.display = 'none';
            
            // D√©sactiver les liens
            document.getElementById('nav-dashboard').classList.remove('active');
            document.getElementById('nav-settings').classList.remove('active');
            document.getElementById('nav-logs').classList.remove('active');
            document.getElementById('nav-orders').classList.remove('active');
            document.getElementById('nav-reviews').classList.remove('active');

            // Afficher la section demand√©e
            if (sectionId === 'dashboard') {
                dashboardContent.style.display = 'block';
                document.getElementById('nav-dashboard').classList.add('active');
                if(window.innerWidth <= 768) toggleSidebar(); // Fermer le menu sur mobile apr√®s clic
            } else if (sectionId === 'logs') {
                logsContent.style.display = 'block';
                document.getElementById('nav-logs').classList.add('active');
                fetchLogs(); // Charger les logs
                if(window.innerWidth <= 768) toggleSidebar();
            } else if (sectionId === 'settings') {
                settingsContent.style.display = 'block';
                document.getElementById('nav-settings').classList.add('active');
                if(window.innerWidth <= 768) toggleSidebar();
            } else if (sectionId === 'orders') {
                ordersContent.style.display = 'block';
                document.getElementById('nav-orders').classList.add('active');
                fetchOrders();
                if(window.innerWidth <= 768) toggleSidebar();
            } else if (sectionId === 'reviews') {
                reviewsContent.style.display = 'block';
                document.getElementById('nav-reviews').classList.add('active');
                fetchReviews();
                if(window.innerWidth <= 768) toggleSidebar();
            }
        }

        function loadLocalData() {
            try {
                const localUser = JSON.parse(localStorage.getItem('abmcyBusinessUser'));
                if (localUser && localUser.numeroCompte === compteId) {
                    // Afficher le nom de l'entreprise imm√©diatement
                    if (localUser.nomEntreprise) {
                        document.querySelector('.main-header h1').textContent = `Tableau de Bord - ${localUser.nomEntreprise}`;
                        document.getElementById('settingsName').value = localUser.nomEntreprise;
                    }
                }
            } catch (e) {
                console.log("Pas de donn√©es locales valides.");
            }
        }

        async function fetchData() {
            loader.style.display = 'block';
            
            try {
                // 1. R√©cup√©rer les infos de l'entreprise depuis l'API Centrale
                const centralResponse = await fetch(`${CENTRAL_API_URL}?action=getBusinessPublicData&compteId=${compteId}`);
                const centralResult = await centralResponse.json();

                if (!centralResult.success) throw new Error(centralResult.error);

                const info = centralResult.data.businessInfo;
                // Mettre √† jour le titre avec le nom officiel venant du serveur
                document.querySelector('.main-header h1').textContent = `Tableau de Bord - ${info.NomEntreprise}`;
                
                BUSINESS_API_URL = info.ApiTypeUrl; // R√©cup√©rer l'URL de l'API sp√©cifique
                
                if (!BUSINESS_API_URL) {
                    throw new Error("L'URL de l'API m√©tier n'est pas configur√©e. Veuillez contacter le support.");
                }

                // Remplir le formulaire de param√®tres
                populateSettingsForm(info);

                // 2. R√©cup√©rer les produits/services depuis l'API Sp√©cifique
                const response = await fetch(BUSINESS_API_URL, {
                    method: 'POST',
                    mode: 'cors',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({
                        action: 'getBusinessItems', // Action pour r√©cup√©rer les donn√©es
                        data: { compteId: compteId }
                    })
                });
                const result = await response.json();

                if (result.status === 'success') {
                    currentServices = result.data.services;
                    currentProducts = result.data.products;
                    renderItems(currentServices, servicesListDiv, 'service');
                    renderItems(currentProducts, productsListDiv, 'produit');
                    loader.style.display = 'none';
                    dashboardContent.style.display = 'block';

                    // 3. R√©cup√©rer le slug actuel
                    const slugResponse = await fetch(CENTRAL_API_URL, { // Utiliser l'API Centrale
                        method: 'POST',
                        mode: 'cors',
                        headers: { 'Content-Type': 'text/plain' },
                        body: JSON.stringify({ action: 'getSlug', data: { compteId: compteId } })
                    });
                    const slugResult = await slugResponse.json();
                    if (slugResult.status === 'success' && slugResult.slug) {
                        currentSlug = slugResult.slug;
                        document.getElementById('settingsSlug').value = currentSlug;
                        
                        // Afficher les statistiques de visites
                        if (slugResult.visits !== undefined) {
                            document.getElementById('visitCount').textContent = slugResult.visits;
                            document.getElementById('visitStats').style.display = 'inline-block';
                            loadVisitChart(); // Charger le graphique
                        }
                        setupQrCodeAndLink(); // Mettre √† jour le lien avec le slug
                    }
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                loader.textContent = `Erreur de chargement : ${error.message}`;
            }
        }

        function populateSettingsForm(info) {
            document.getElementById('settingsName').value = info.NomEntreprise || '';
            document.getElementById('settingsDesc').value = info.Description || '';
            document.getElementById('settingsPhone').value = info.Telephone || '';
            document.getElementById('settingsAddress').value = info.Adresse || '';
            document.getElementById('settingsWaveUrl').value = info.WaveBaseUrl || '';
            
            if (info.LogoUrl) {
                document.getElementById('previewLogo').src = info.LogoUrl;
                document.getElementById('previewLogo').style.display = 'block';
                document.getElementById('currentLogoUrl').value = info.LogoUrl;

                // Mise √† jour du logo dans la sidebar pour v√©rification visuelle imm√©diate
                const sidebarLogo = document.getElementById('sidebar-logo');
                if (sidebarLogo && info.LogoUrl) {
                    sidebarLogo.src = info.LogoUrl;
                    sidebarLogo.style.display = 'inline-block';
                }
            }
            
            if (info.CoverImageUrl) {
                document.getElementById('previewCover').src = info.CoverImageUrl;
                document.getElementById('previewCover').style.display = 'block';
                document.getElementById('currentCoverUrl').value = info.CoverImageUrl;
            }
        }

        function setupImagePreviews() {
            ['settingsLogo', 'settingsCover'].forEach(id => {
                document.getElementById(id).addEventListener('change', function(e) {
                    if (this.files && this.files[0]) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const previewId = id === 'settingsLogo' ? 'previewLogo' : 'previewCover';
                            const img = document.getElementById(previewId);
                            img.src = e.target.result;
                            img.style.display = 'block';
                        };
                        reader.readAsDataURL(this.files[0]);
                    }
                });
            });
        }

        function renderItems(items, container, type) {
            container.innerHTML = ''; // Vider la liste
            if (items.length === 0) {
                container.innerHTML = `<p>Aucun ${type} ajout√© pour le moment.</p>`;
                return;
            }

            items.forEach(item => {
                const name = item.Nom || item.NomService || item.NomProduit;
                const price = item.Prix;
                const itemId = item.IDItem;
                const stockDisplay = (type === 'produit') ? ` | Stock: ${item.Stock || 0}` : '';
                const imageUrl = item.ImageUrl || item.Image || ''; 
                const imgHtml = imageUrl ? `<img src="${imageUrl}" class="item-thumb" alt="${name}">` : '';

                const itemDiv = document.createElement('div');
                itemDiv.className = 'list-item';
                itemDiv.innerHTML = `
                    <div class="item-info">
                        ${imgHtml}
                        <div class="item-details">
                            ${name} <span class="item-price">${price}‚Ç¨</span>
                            <span style="font-size:0.8em; color:#666;">${stockDisplay}</span>
                        </div>
                    </div>
                    <div class="item-actions">
                        <button class="edit-btn" onclick="handleEditItem('${itemId}', '${type}')">Modifier</button>
                        ${type === 'produit' ? `<button class="stock-btn" onclick="handleStockItem('${itemId}')">Stock</button>` : ''}
                        <button class="delete-btn" onclick="handleDeleteItem('${itemId}', '${type}')">Supprimer</button>
                    </div>
                `;
                container.appendChild(itemDiv);
            });
        }

        async function fetchLogs() {
            const tbody = document.getElementById('logsTableBody');
            tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;">Chargement...</td></tr>';

            try {
                const response = await fetch(BUSINESS_API_URL, {
                    method: 'POST',
                    mode: 'cors',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({
                        action: 'getLogs',
                        data: { compteId: compteId }
                    })
                });
                const result = await response.json();

                if (result.status === 'success') {
                    tbody.innerHTML = '';
                    if (result.data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;">Aucune activit√© enregistr√©e.</td></tr>';
                        return;
                    }

                    result.data.forEach(log => {
                        const date = new Date(log.Date).toLocaleString('fr-FR');
                        let badgeClass = 'badge';
                        if (log.Action.includes('Ajout')) badgeClass += ' badge-add';
                        else if (log.Action.includes('Modification')) badgeClass += ' badge-edit';
                        else if (log.Action.includes('Suppression')) badgeClass += ' badge-delete';

                        const row = `<tr>
                            <td class="log-date">${date}</td>
                            <td class="log-action"><span class="${badgeClass}">${log.Action}</span></td>
                            <td class="log-details">${log.Details}</td>
                        </tr>`;
                        tbody.innerHTML += row;
                    });
                }
            } catch (error) {
                tbody.innerHTML = `<tr><td colspan="3" style="color:red;">Erreur: ${error.message}</td></tr>`;
            }
        }

        // --- Gestion des Avis ---
        async function fetchReviews() {
            const container = document.getElementById('reviewsList');
            container.innerHTML = '<p>Chargement des avis...</p>';

            try {
                const response = await fetch(BUSINESS_API_URL, {
                    method: 'POST',
                    mode: 'cors',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({
                        action: 'getReviews',
                        data: { compteId: compteId }
                    })
                });
                const result = await response.json();

                if (result.status === 'success') {
                    container.innerHTML = '';
                    if (result.data.length === 0) {
                        container.innerHTML = '<p>Aucun avis re√ßu pour le moment.</p>';
                        return;
                    }

                    result.data.forEach(review => {
                        const isVisible = String(review.Visible).toLowerCase() === 'true';
                        const date = new Date(review.Date).toLocaleDateString('fr-FR');
                        const note = review.Note || 5;
                        const stars = '‚òÖ'.repeat(note) + '‚òÜ'.repeat(5 - note);
                        
                        const div = document.createElement('div');
                        div.className = 'list-item';
                        div.innerHTML = `
                            <div class="item-info" style="flex-direction: column; align-items: flex-start; gap: 5px;">
                                <div><strong>${review.Prenom} ${review.Nom}</strong> <span style="color: #D4AF37;">${stars}</span> <span style="font-size:0.8em; color:#666;">(${date})</span></div>
                                <div style="font-size: 0.9em; color: #28a745;">üëç ${review.PointsPositifs}</div>
                                <div style="font-size: 0.9em; color: #dc3545;">üîß ${review.PointsAmeliorer}</div>
                            </div>
                            <div class="item-actions">
                                <button onclick="toggleReview('${review.IDAvis}', ${!isVisible})" class="${isVisible ? 'delete-btn' : 'stock-btn'}">
                                    ${isVisible ? 'Masquer' : 'Afficher Public'}
                                </button>
                            </div>
                        `;
                        container.appendChild(div);
                    });
                }
            } catch (error) {
                container.innerHTML = `<p style="color:red;">Erreur: ${error.message}</p>`;
            }
        }

        async function toggleReview(reviewId, newStatus) {
            try {
                await fetch(BUSINESS_API_URL, {
                    method: 'POST',
                    mode: 'cors',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({
                        action: 'toggleReviewVisibility',
                        data: { compteId: compteId, reviewId: reviewId, visible: newStatus }
                    })
                });
                fetchReviews(); // Rafra√Æchir la liste
            } catch (e) { alert("Erreur: " + e.message); }
        }

        // --- Gestion des Commandes & Clients ---
        let currentOrders = [];
        let currentOrderId = null;
        let salesChartInstance = null;
        let statusChartInstance = null;

        function switchOrderTab(tab) {
            const overviewSection = document.getElementById('overview-section');
            const ordersSection = document.getElementById('orders-section');
            const clientsSection = document.getElementById('clients-section');
            
            const btnOverview = document.getElementById('tab-overview');
            const btnOrders = document.getElementById('tab-orders-list');
            const btnClients = document.getElementById('tab-clients-list');

            // Reset
            overviewSection.style.display = 'none';
            ordersSection.style.display = 'none';
            clientsSection.style.display = 'none';
            btnOverview.style.backgroundColor = '#6c757d';
            btnOrders.style.backgroundColor = '#6c757d';
            btnClients.style.backgroundColor = '#6c757d';

            if (tab === 'overview') {
                overviewSection.style.display = 'block';
                btnOverview.style.backgroundColor = 'var(--primary-color)';
                updateDashboardCharts();
            } else if (tab === 'orders') {
                ordersSection.style.display = 'block';
                btnOrders.style.backgroundColor = 'var(--primary-color)';
            } else if (tab === 'clients') {
                clientsSection.style.display = 'block';
                btnClients.style.backgroundColor = 'var(--primary-color)';
                renderClients(); // G√©n√©rer la liste des clients √† partir des commandes
            }
        }

        async function fetchOrders() {
            const tbody = document.getElementById('ordersTableBody');
            tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">Chargement des commandes...</td></tr>';

            try {
                const response = await fetch(CENTRAL_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({
                        action: 'getPartnerOrders',
                        data: { compteId: compteId }
                    })
                });
                const result = await response.json();

                if (result.success) {
                    currentOrders = result.data;
                    calculateStats(); // Calculer les stats d√®s r√©ception
                    renderOrdersTable(currentOrders);
                } else {
                    throw new Error(result.error || "Erreur lors de la r√©cup√©ration des commandes.");
                }
            } catch (error) {
                tbody.innerHTML = `<tr><td colspan="7" style="color:red; text-align:center;">Erreur: ${error.message}</td></tr>`;
            }
        }

        function calculateStats() {
            if (!currentOrders || currentOrders.length === 0) return;

            // 1. KPIs
            const totalRevenue = currentOrders.reduce((sum, order) => sum + (parseFloat(order.total) || 0), 0);
            const totalOrders = currentOrders.length;
            const uniqueClients = new Set(currentOrders.map(o => o.customer.email)).size;
            const averageOrderValue = totalOrders > 0 ? totalRevenue / totalOrders : 0;

            document.getElementById('stat-revenue').textContent = totalRevenue.toLocaleString('fr-FR') + ' FCFA';
            document.getElementById('stat-orders').textContent = totalOrders;
            document.getElementById('stat-clients').textContent = uniqueClients;
            document.getElementById('stat-aov').textContent = Math.round(averageOrderValue).toLocaleString('fr-FR') + ' FCFA';

            // 2. Charts Data
            updateDashboardCharts();
        }

        function updateDashboardCharts() {
            if (!currentOrders || currentOrders.length === 0) return;
            
            // Sales over time
            const salesByDate = {};
            currentOrders.forEach(order => {
                const date = new Date(order.date).toLocaleDateString('fr-FR'); // DD/MM/YYYY
                salesByDate[date] = (salesByDate[date] || 0) + (parseFloat(order.total) || 0);
            });
            
            // Sort dates
            const sortedDates = Object.keys(salesByDate).sort((a, b) => {
                const [da, ma, ya] = a.split('/');
                const [db, mb, yb] = b.split('/');
                return new Date(`${ya}-${ma}-${da}`) - new Date(`${yb}-${mb}-${db}`);
            });
            
            const salesData = sortedDates.map(d => salesByDate[d]);

            // Status distribution
            const statusCounts = {};
            currentOrders.forEach(order => {
                const status = order.status || 'Inconnu';
                statusCounts[status] = (statusCounts[status] || 0) + 1;
            });

            // Render Sales Chart
            const ctxSales = document.getElementById('salesChart').getContext('2d');
            if (salesChartInstance) salesChartInstance.destroy();
            
            salesChartInstance = new Chart(ctxSales, {
                type: 'line',
                data: {
                    labels: sortedDates,
                    datasets: [{
                        label: 'Ventes (F CFA)',
                        data: salesData,
                        borderColor: '#007bff',
                        backgroundColor: 'rgba(0, 123, 255, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });

            // Render Status Chart
            const ctxStatus = document.getElementById('statusChart').getContext('2d');
            if (statusChartInstance) statusChartInstance.destroy();

            statusChartInstance = new Chart(ctxStatus, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(statusCounts),
                    datasets: [{
                        data: Object.values(statusCounts),
                        backgroundColor: ['#ffc107', '#007bff', '#28a745', '#dc3545', '#6c757d']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        function renderOrdersTable(orders) {
            const tbody = document.getElementById('ordersTableBody');
            tbody.innerHTML = '';
            if (orders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">Aucune commande trouv√©e.</td></tr>';
                return;
            }

            orders.forEach(order => {
                const date = new Date(order.date).toLocaleDateString('fr-FR');
                let statusColor = '#6c757d'; // gris
                if (order.status === 'En cours') statusColor = '#007bff'; // bleu
                if (order.status === 'Livr√©e') statusColor = '#28a745'; // vert
                if (order.status === 'Annul√©e') statusColor = '#dc3545'; // rouge

                const row = `<tr>
                    <td><span style="font-family: monospace; font-weight: bold;">${order.id}</span></td>
                    <td>${date}</td>
                    <td>${order.customer.firstname} ${order.customer.lastname}</td>
                    <td style="font-weight: bold;">${order.total.toLocaleString('fr-FR')} FCFA</td>
                    <td>${order.paymentMethod === 'cod' ? '√Ä la livraison' : 'En ligne'}</td>
                    <td><span class="badge" style="background-color: ${statusColor};">${order.status}</span></td>
                    <td><button onclick="openOrderModal('${order.id}')" style="background: none; border: 1px solid var(--accent-color); color: var(--accent-color); padding: 0.3rem 0.8rem; border-radius: 4px; cursor: pointer;">D√©tails</button></td>
                </tr>`;
                tbody.innerHTML += row;
            });
        }

        function filterOrders() {
            const searchTerm = document.getElementById('orderSearch').value.toLowerCase();
            const statusFilter = document.getElementById('orderStatusFilter').value;

            const filtered = currentOrders.filter(order => {
                const matchesSearch = order.id.toLowerCase().includes(searchTerm) || 
                                      (order.customer.firstname + ' ' + order.customer.lastname).toLowerCase().includes(searchTerm);
                const matchesStatus = statusFilter === '' || order.status === statusFilter;
                return matchesSearch && matchesStatus;
            });

            renderOrdersTable(filtered);
        }

        function renderClients() {
            const tbody = document.getElementById('clientsTableBody');
            tbody.innerHTML = '';
            
            // Extraire les clients uniques
            const clientsMap = new Map();
            currentOrders.forEach(order => {
                const email = order.customer.email;
                if (!clientsMap.has(email)) {
                    clientsMap.set(email, {
                        ...order.customer,
                        orderCount: 0
                    });
                }
                clientsMap.get(email).orderCount++;
            });

            if (clientsMap.size === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Aucun client trouv√©.</td></tr>';
                return;
            }

            clientsMap.forEach(client => {
                const row = `<tr>
                    <td>${client.firstname} ${client.lastname}</td>
                    <td>${client.email}</td>
                    <td>${client.phone}</td>
                    <td>${client.address || '-'}</td>
                    <td style="text-align:center;"><span class="badge" style="background-color: var(--accent-color);">${client.orderCount}</span></td>
                </tr>`;
                tbody.innerHTML += row;
            });
        }

        function openOrderModal(orderId) {
            const order = currentOrders.find(o => o.id === orderId);
            if (!order) return;

            currentOrderId = orderId;
            document.getElementById('modalOrderId').textContent = order.id;
            document.getElementById('modalClientName').textContent = `${order.customer.firstname} ${order.customer.lastname}`;
            document.getElementById('modalClientEmail').textContent = order.customer.email;
            document.getElementById('modalClientPhone').textContent = order.customer.phone;
            document.getElementById('modalClientAddress').textContent = order.customer.address || 'Non sp√©cifi√©e';
            document.getElementById('modalClientNote').textContent = order.customer.notes || 'Aucune';
            
            document.getElementById('modalOrderDate').textContent = new Date(order.date).toLocaleString('fr-FR');
            document.getElementById('modalOrderTotal').textContent = `${order.total.toLocaleString('fr-FR')} FCFA`;
            document.getElementById('modalPaymentType').textContent = order.paymentMethod === 'cod' ? 'Paiement √† la livraison' : 'Paiement en ligne';
            document.getElementById('modalOrderStatus').value = order.status;

            const itemsContainer = document.getElementById('modalOrderItems');
            itemsContainer.innerHTML = '';
            order.items.forEach(item => {
                itemsContainer.innerHTML += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: #f8f9fa; border-radius: 6px;">
                        <span>${item.name} (x${item.quantity})</span>
                        <span style="font-weight: bold;">${(item.price * item.quantity).toLocaleString('fr-FR')} FCFA</span>
                    </div>
                `;
            });

            document.getElementById('order-modal').style.display = 'flex';
        }

        function closeOrderModal() {
            document.getElementById('order-modal').style.display = 'none';
        }

        async function updateOrderStatus() {
            const newStatus = document.getElementById('modalOrderStatus').value;
            try {
                const response = await fetch(CENTRAL_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({
                        action: 'updatePartnerOrderStatus',
                        data: { compteId: compteId, orderId: currentOrderId, status: newStatus }
                    })
                });
                const result = await response.json();
                if (result.success) {
                    alert("Statut mis √† jour !");
                    closeOrderModal();
                    fetchOrders();
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                alert("Erreur : " + error.message);
            }
        }

        async function handleAddItem(e, type) {
            e.preventDefault();
            const form = e.target;
            const prefix = type === 'service' ? 'service' : 'product';
            
            const nameInput = document.getElementById(`${prefix}Name`);
            const idInput = document.getElementById(`${prefix}Id`);
            const priceInput = document.getElementById(`${prefix}Price`);
            const fileInput = document.getElementById(`${prefix}Image`);
            const categoryInput = document.getElementById(`${prefix}Category`);
            const characteristicsInput = document.getElementById(`${prefix}Characteristics`);
            const descriptionInput = document.getElementById(`${prefix}Description`);
            const stockInput = document.getElementById('productStock');
            const submitBtn = form.querySelector('button[type="submit"]');

            const nom = nameInput.value;
            const prix = parseFloat(priceInput.value);
            const category = categoryInput ? categoryInput.value : '';
            const characteristics = characteristicsInput ? characteristicsInput.value : '';
            const description = descriptionInput ? descriptionInput.value : '';
            const stock = (type === 'produit' && stockInput) ? parseInt(stockInput.value) : 0;
            let imageUrl = '';
            const isEdit = idInput && idInput.value;

            if (!nom || isNaN(prix)) {
                alert("Veuillez remplir tous les champs avec des valeurs valides.");
                return;
            }

            submitBtn.disabled = true;
            submitBtn.textContent = 'Traitement...';

            try {
                // Upload de l'image si pr√©sente
                if (isEdit && (!fileInput || !fileInput.files[0])) {
                    // Keep existing image
                    const items = type === 'service' ? currentServices : currentProducts;
                    const item = items.find(i => i.IDItem === idInput.value);
                    if (item) imageUrl = item.ImageUrl || item.Image || '';
                }
                if (fileInput && fileInput.files[0]) {
                    submitBtn.textContent = 'Upload image...';
                    if (typeof uploadImageToImgBB === 'function') {
                        imageUrl = await uploadImageToImgBB(fileInput.files[0]);
                    } else {
                        console.warn("Fonction uploadImageToImgBB non trouv√©e.");
                    }
                }
            } catch (err) {
                alert("Erreur lors de l'upload de l'image : " + err.message);
                submitBtn.disabled = false;
                submitBtn.textContent = 'Ajouter';
                return;
            }

            // Utilisation d'une structure coh√©rente avec 'action' et 'data'
            const payload = {
                action: type === 'service' ? (isEdit ? 'updateService' : 'addService') : (isEdit ? 'updateProduct' : 'addProduct'),
                data: {
                    compteId: compteId,
                    item: { id: isEdit ? idInput.value : null, nom, prix, imageUrl, category, characteristics, description, stock }
                }
            };

            submitBtn.textContent = isEdit ? 'Mise √† jour...' : 'Enregistrement...';

            try {
                const response = await fetch(BUSINESS_API_URL, {
                    method: 'POST',
                    mode: 'cors',
                    headers: { 'Content-Type': 'text/plain' }, // Coh√©rence avec les autres appels
                    body: JSON.stringify(payload)
                });
                const result = await response.json();

                if (result.status === 'success') {
                    resetForm(type); // Vider le formulaire et reset mode
                    await fetchData(); // Rafra√Æchir les listes
                } else {
                    throw new Error(result.message || "Une erreur inconnue est survenue.");
                }
            } catch (error) {
                alert(`Erreur lors de l'ajout : ${error.message}`);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = isEdit ? 'Mettre √† jour' : 'Ajouter';
            }
        }

        function handleEditItem(itemId, type) {
            const items = type === 'service' ? currentServices : currentProducts;
            const item = items.find(i => i.IDItem === itemId);
            if (!item) return;

            const prefix = type === 'service' ? 'service' : 'product';
            document.getElementById(`${prefix}Id`).value = item.IDItem;
            document.getElementById(`${prefix}Name`).value = item.Nom || item.NomService || item.NomProduit;
            document.getElementById(`${prefix}Price`).value = item.Prix;
            if (document.getElementById(`${prefix}Category`)) document.getElementById(`${prefix}Category`).value = item.Categorie || '';
            if (document.getElementById(`${prefix}Characteristics`)) document.getElementById(`${prefix}Characteristics`).value = item.Caracteristiques || '';
            if (document.getElementById(`${prefix}Description`)) document.getElementById(`${prefix}Description`).value = item.Description || '';
            
            if (type === 'produit') {
                document.getElementById('productStock').value = item.Stock || 0;
            }

            const form = document.getElementById(type === 'service' ? 'addServiceForm' : 'addProductForm');
            const btn = form.querySelector('button[type="submit"]');
            btn.textContent = 'Mettre √† jour';
            
            form.scrollIntoView({ behavior: 'smooth' });
        }

        async function handleStockItem(itemId) {
            const item = currentProducts.find(i => i.IDItem === itemId);
            if (!item) return;
            
            const newStock = prompt(`Stock actuel pour ${item.Nom || item.NomProduit}: ${item.Stock || 0}\nNouveau stock :`, item.Stock || 0);
            if (newStock === null) return;
            
            const stockVal = parseInt(newStock);
            if (isNaN(stockVal)) {
                alert("Valeur invalide");
                return;
            }

            try {
                const response = await fetch(BUSINESS_API_URL, {
                    method: 'POST',
                    mode: 'cors',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({
                        action: 'updateProduct',
                        data: {
                            compteId: compteId,
                            item: { id: itemId, stock: stockVal }
                        }
                    })
                });
                const result = await response.json();
                if (result.status === 'success') {
                    alert("Stock mis √† jour !");
                    fetchData();
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                alert(`Erreur : ${error.message}`);
            }
        }

        async function handleDeleteItem(itemId, type) {
            if (!confirm("√ätes-vous s√ªr de vouloir supprimer cet √©l√©ment ?")) return;

            try {
                const response = await fetch(BUSINESS_API_URL, {
                    method: 'POST',
                    mode: 'cors',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({
                        action: 'deleteItem',
                        data: { 
                            compteId: compteId, // Ajout du compteId manquant
                            itemId: itemId, 
                            type: type 
                        }
                    })
                });
                const result = await response.json();

                if (result.status === 'success') {
                    alert("√âl√©ment supprim√© avec succ√®s.");
                    fetchData(); // Recharger la liste
                } else {
                    throw new Error(result.message || "Erreur lors de la suppression.");
                }
            } catch (error) {
                alert(`Erreur : ${error.message}`);
            }
        }

        function logout() {
            if (confirm("√ätes-vous s√ªr de vouloir vous d√©connecter ?")) {
                // Supprimer les donn√©es de session locales
                localStorage.removeItem('abmcyBusinessUser');
                // Rediriger vers la page d'authentification
                window.location.href = 'inscription-entreprise.html';
            }
        }

        // Gestion de la sauvegarde des param√®tres
        document.getElementById('settingsForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            const slugFeedback = document.getElementById('slug-feedback');
            btn.disabled = true;
            btn.textContent = 'Sauvegarde en cours...';
            slugFeedback.textContent = '';

            try {
                // 1. Upload des images si nouvelles
                const logoFile = document.getElementById('settingsLogo').files[0];
                const coverFile = document.getElementById('settingsCover').files[0];
                
                let logoUrl = document.getElementById('currentLogoUrl').value;
                let coverUrl = document.getElementById('currentCoverUrl').value;

                if (logoFile) logoUrl = await uploadImageToImgBB(logoFile);
                if (coverFile) coverUrl = await uploadImageToImgBB(coverFile);

                // 1.5 Sauvegarder le slug (alias)
                const slugVal = document.getElementById('settingsSlug').value;
                if (slugVal && slugVal !== currentSlug) { // Ne sauvegarder que si la valeur a chang√©
                    try {
                        const slugResponse = await fetch(CENTRAL_API_URL, { // Utiliser l'API Centrale
                            method: 'POST',
                            headers: { 'Content-Type': 'text/plain' },
                            body: JSON.stringify({ action: 'setSlug', data: { compteId: compteId, slug: slugVal } })
                        });
                        const slugResult = await slugResponse.json();
                        if (slugResult.status !== 'success') throw new Error(slugResult.message);
                        
                        currentSlug = slugResult.slug; // Mettre √† jour avec la version nettoy√©e
                        document.getElementById('settingsSlug').value = currentSlug;
                        slugFeedback.style.color = 'var(--success-color)';
                        slugFeedback.textContent = 'Identifiant enregistr√© !';

                        // NOUVEAU: Synchronisation avec l'API Business (Les deux APIs)
                        try {
                            await fetch(BUSINESS_API_URL, {
                                method: 'POST',
                                mode: 'cors',
                                headers: { 'Content-Type': 'text/plain' },
                                body: JSON.stringify({ action: 'setSlug', data: { compteId: compteId, slug: currentSlug } })
                            });
                        } catch (syncError) { console.warn("Erreur sync slug business:", syncError); }
                    } catch (slugError) {
                        slugFeedback.style.color = 'var(--danger-color)';
                        slugFeedback.textContent = slugError.message;
                    }
                }

                // 2. Pr√©parer les donn√©es
                const updateData = {
                    compteId: compteId,
                    nom: document.getElementById('settingsName').value,
                    description: document.getElementById('settingsDesc').value,
                    telephone: document.getElementById('settingsPhone').value,
                    adresse: document.getElementById('settingsAddress').value,
                    waveBaseUrl: document.getElementById('settingsWaveUrl').value,
                    logoUrl: logoUrl,
                    coverImageUrl: coverUrl
                };

                // 3. Envoyer √† l'API Centrale
                const response = await fetch(CENTRAL_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({ action: 'updateBusinessInfo', data: updateData })
                });
                const result = await response.json();

                if (result.success) {
                    alert("Informations mises √† jour avec succ√®s !");
                    fetchData(); // Recharger les donn√©es pour voir les changements
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                alert("Erreur lors de la sauvegarde : " + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Enregistrer les modifications';
            }
        });

        // NOUVEAU: Gestion du changement de mot de passe
        document.getElementById('changePasswordForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const currentPwd = document.getElementById('currentPassword').value;
            const newPwd = document.getElementById('newPassword').value;
            const confirmPwd = document.getElementById('confirmNewPassword').value;
            const btn = e.target.querySelector('button');

            if (newPwd !== confirmPwd) {
                alert("Les nouveaux mots de passe ne correspondent pas.");
                return;
            }

            btn.disabled = true;
            btn.textContent = 'Modification en cours...';

            try {
                const response = await fetch(CENTRAL_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({
                        action: 'changeBusinessPassword',
                        data: {
                            compteId: compteId,
                            currentPassword: currentPwd,
                            newPassword: newPwd
                        }
                    })
                });
                const result = await response.json();

                if (result.success) {
                    alert("Mot de passe modifi√© avec succ√®s !");
                    e.target.reset();
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                alert("Erreur : " + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Changer le mot de passe';
            }
        });

        function setupQrCodeAndLink() {
            // Construit l'URL de la page publique (babershop.html)
            let path = window.location.pathname;
            // CORRECTION: G√©rer les URLs avec ou sans extension .html (Clean URLs) pour g√©n√©rer le bon lien public
            if (path.includes('dashboard-admin.html')) {
                path = path.replace('dashboard-admin.html', 'babershop.html');
            } else {
                path = path.replace('dashboard-admin', 'babershop');
            }
            let publicUrl = `${window.location.origin}${path}`;
            
            // Si on a un slug, on l'utilise pour une URL plus jolie
            if (currentSlug) {
                publicUrl += `?alias=${currentSlug}`;
            } else {
                publicUrl += `?compteId=${compteId}`;
            }
            
            const linkInput = document.getElementById('publicLinkInput');
            if (linkInput) linkInput.value = publicUrl;
            
            const previewBtn = document.getElementById('previewBtn');
            if (previewBtn) {
                previewBtn.href = publicUrl;
            }

            // Attendre que la librairie QR Code soit charg√©e
            script.onload = () => {
                const qrContainer = document.getElementById('qrCodeContainer');
                qrContainer.innerHTML = ''; // Vider au cas o√π
                const canvas = document.createElement('canvas');
                qrContainer.appendChild(canvas);
                QRCode.toCanvas(canvas, publicUrl, { width: 200 }, (error) => {
                    if (error) console.error(error);
                });
            };
        }

        function copyLink() {
            const copyText = document.getElementById("publicLinkInput");
            copyText.select();
            copyText.setSelectionRange(0, 99999); /* Pour mobile */
            navigator.clipboard.writeText(copyText.value).then(() => {
                const btn = document.querySelector('.copy-btn');
                const originalText = btn.textContent;
                btn.textContent = "Copi√© !";
                btn.style.color = "var(--success-color)";
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.color = "";
                }, 2000);
            });
        }

        function shareNative() {
            const url = document.getElementById("publicLinkInput").value;
            if (navigator.share) {
                navigator.share({
                    title: document.querySelector('.main-header h1').textContent,
                    text: 'D√©couvrez mes services et produits sur ma boutique en ligne !',
                    url: url
                }).catch(console.error);
            } else {
                copyLink();
                alert("Lien copi√© dans le presse-papier !");
            }
        }

        function downloadQrCode() {
            const container = document.getElementById('qrCodeContainer');
            const canvas = container.querySelector('canvas');
            const phone = document.getElementById('settingsPhone').value || "Service Client";
            
            if (canvas) {
                // Cr√©ation d'un canvas temporaire pour l'image "Immersive"
                const finalCanvas = document.createElement('canvas');
                const ctx = finalCanvas.getContext('2d');
                const padding = 40;
                const bottomSpace = 100;
                
                // Dimensions
                finalCanvas.width = canvas.width + (padding * 2);
                finalCanvas.height = canvas.height + (padding * 2) + bottomSpace;
                
                // 1. Fond (Couleur de base - Noir #1a1a1a)
                ctx.fillStyle = "#1a1a1a"; 
                ctx.fillRect(0, 0, finalCanvas.width, finalCanvas.height);
                
                // 2. Carr√© blanc pour le QR Code
                ctx.fillStyle = "#ffffff";
                ctx.fillRect(padding - 10, padding - 10, canvas.width + 20, canvas.height + 20);
                
                // 3. Dessiner le QR Code
                ctx.drawImage(canvas, padding, padding);
                
                // 4. Texte "Service Client"
                ctx.fillStyle = "#ffffff";
                ctx.font = "bold 16px Poppins, sans-serif";
                ctx.textAlign = "center";
                ctx.fillText(`Service Client : ${phone}`, finalCanvas.width / 2, canvas.height + padding + 50);
                
                // 5. Texte "Powered by ABMCY"
                ctx.fillStyle = "#D4AF37"; // Couleur Or
                ctx.font = "italic 14px Poppins, sans-serif";
                ctx.fillText("Powered by ABMCY", finalCanvas.width / 2, canvas.height + padding + 80);

                // T√©l√©chargement
                const link = document.createElement('a');
                link.download = 'QRCode-Boutique-Pro.png';
                link.href = finalCanvas.toDataURL();
                link.click();
            } else {
                alert("Le QR Code n'est pas encore g√©n√©r√©.");
            }
        }

        async function loadVisitChart() {
            try {
                const response = await fetch(CENTRAL_API_URL, { // Utiliser l'API Centrale
                    method: 'POST',
                    mode: 'cors',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({ action: 'getVisitStats', data: { compteId: compteId } })
                });
                const result = await response.json();

                if (result.status === 'success' && result.data.length > 0) {
                    document.getElementById('chartWrapper').style.display = 'block';
                    const ctx = document.getElementById('visitsChart').getContext('2d');
                    
                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: result.labels,
                            datasets: [{
                                label: 'Visites (7 derniers jours)',
                                data: result.data,
                                borderColor: '#007bff',
                                backgroundColor: 'rgba(0, 123, 255, 0.1)',
                                borderWidth: 2,
                                tension: 0.3,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false }
                            },
                            scales: {
                                y: { beginAtZero: true, ticks: { precision: 0 } }
                            }
                        }
                    });
                }
            } catch (e) { console.error("Erreur graphique:", e); }
        }

        // Lier les formulaires √† la fonction d'ajout
        document.getElementById('addServiceForm').addEventListener('submit', (e) => handleAddItem(e, 'service'));
        document.getElementById('addProductForm').addEventListener('submit', (e) => handleAddItem(e, 'produit'));

    </script>

</body>
</html>